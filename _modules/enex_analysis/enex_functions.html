<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html"><link rel="search" title="Search" href="../../search.html">
        <link rel="canonical" href="https://bet-lab.github.io/enex_analysis_engine/_modules/enex_analysis/enex_functions.html">

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>enex_analysis.enex_functions - Energy-Exergy Analysis Engine</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=200b7bb1" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  --color-brand-primary: #4051b5;
  --color-brand-content: #4051b5;
  --color-sidebar-background: #f8f9fa;
  --color-sidebar-background-border: #e9ecef;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #7c88cc;
  --color-brand-content: #7c88cc;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #7c88cc;
  --color-brand-content: #7c88cc;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Energy-Exergy Analysis Engine</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <span class="sidebar-brand-text">Energy-Exergy Analysis Engine</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../getting-started/index.html">Getting Started</a><input aria-label="Toggle navigation of Getting Started" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/quickstart.html">Quick Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/configuration.html">Configuration</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../guides/index.html">User Guides</a><input aria-label="Toggle navigation of User Guides" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../guides/user-guide.html">User Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guides/io-guide.html">Input/Output Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guides/advanced-topics.html">Advanced Topics</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples/index.html">Examples</a><input aria-label="Toggle navigation of Examples" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/analysis-basics.html">Analysis Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/electric-boiler.html">Electric Boiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/gas-boiler.html">Gas Boiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/solar-assisted-gas-boiler.html">Solar-Assisted Gas Boiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/heat-pump-boiler.html">Heat Pump Boiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/ground-source-heat-pump-boiler.html">Ground Source Heat Pump Boiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/air-source-heat-pump.html">Air Source Heat Pump</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/ground-source-heat-pump.html">Ground Source Heat Pump</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/components.html">Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/advanced-examples.html">Advanced Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/tips.html">Tips and Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/index.html">API Reference</a><input aria-label="Toggle navigation of API Reference" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/core.html">Core Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/engines.html">Energy System Engines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/utilities.html">Utility Functions</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../theory/index.html">Theory &amp; Background</a><input aria-label="Toggle navigation of Theory &amp; Background" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../theory/thermodynamics.html">Thermodynamics Fundamentals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../theory/exergy-analysis.html">Exergy Analysis Theory</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bet-lab/enex_analysis_engine">GitHub Repository</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for enex_analysis.enex_functions</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utility functions for energy, entropy, and exergy analysis.</span>

<span class="sd">This module contains helper functions for calculations including:</span>
<span class="sd">- Friction factor calculations</span>
<span class="sd">- Heat transfer coefficient calculations</span>
<span class="sd">- Curve fitting functions</span>
<span class="sd">- COP calculations for heat pumps</span>
<span class="sd">- G-function calculations for ground source heat pumps</span>
<span class="sd">- Balance printing utilities</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span><span class="p">,</span> <span class="n">root_scalar</span><span class="p">,</span> <span class="n">minimize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">integrate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">erf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">CoolProp.CoolProp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">CP</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">dartwork_mpl</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dm</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># dartwork_mpl이 없는 경우를 대비한 fallback</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="kc">None</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">calc_util</span> <span class="k">as</span> <span class="n">cu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">SP</span><span class="p">,</span> <span class="n">c_a</span><span class="p">,</span> <span class="n">rho_a</span><span class="p">,</span> <span class="n">c_w</span><span class="p">,</span> <span class="n">rho_w</span>


<div class="viewcode-block" id="darcy_friction_factor">
<a class="viewcode-back" href="../../api/utilities.html#enex_analysis_engine.enex_engine.darcy_friction_factor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">darcy_friction_factor</span><span class="p">(</span><span class="n">Re</span><span class="p">,</span> <span class="n">e_d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Darcy friction factor for given Reynolds number and relative roughness.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Re : float</span>
<span class="sd">        Reynolds number</span>
<span class="sd">    e_d : float</span>
<span class="sd">        Relative roughness (e/D)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Darcy friction factor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Laminar flow</span>
    <span class="k">if</span> <span class="n">Re</span> <span class="o">&lt;</span> <span class="mi">2300</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">64</span> <span class="o">/</span> <span class="n">Re</span>
    <span class="c1"># Turbulent flow</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.25</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">e_d</span> <span class="o">/</span> <span class="mf">3.7</span> <span class="o">+</span> <span class="mf">5.74</span> <span class="o">/</span> <span class="n">Re</span> <span class="o">**</span> <span class="mf">0.9</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span></div>



<div class="viewcode-block" id="calc_h_vertical_plate">
<a class="viewcode-back" href="../../api/utilities.html#enex_analysis_engine.enex_engine.calc_h_vertical_plate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_h_vertical_plate</span><span class="p">(</span><span class="n">T_s</span><span class="p">,</span> <span class="n">T_inf</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate natural convection heat transfer coefficient for a vertical plate.</span>
<span class="sd">    </span>
<span class="sd">    This function calculates the heat transfer coefficient due to natural convection</span>
<span class="sd">    using the Churchill &amp; Chu correlation.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    T_s : float</span>
<span class="sd">        Surface temperature [K]</span>
<span class="sd">    T_inf : float</span>
<span class="sd">        Fluid temperature [K]</span>
<span class="sd">    L : float</span>
<span class="sd">        Characteristic length [m]</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Heat transfer coefficient [W/m²K]</span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Uses Churchill &amp; Chu correlation.</span>
<span class="sd">    Reference: https://doi.org/10.1016/0017-9310(75)90243-4</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Air properties @ 40°C</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="mf">1.6e-5</span>  <span class="c1"># Kinematic viscosity [m²/s]</span>
    <span class="n">k_air</span> <span class="o">=</span> <span class="mf">0.027</span>  <span class="c1"># Thermal conductivity [W/m·K]</span>
    <span class="n">Pr</span> <span class="o">=</span> <span class="mf">0.7</span>  <span class="c1"># Prandtl number</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">((</span><span class="n">T_s</span> <span class="o">+</span> <span class="n">T_inf</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Thermal expansion coefficient [1/K]</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>  <span class="c1"># Gravitational acceleration [m/s²]</span>

    <span class="c1"># Calculate Rayleigh number</span>
    <span class="n">delta_T</span> <span class="o">=</span> <span class="n">T_s</span> <span class="o">-</span> <span class="n">T_inf</span>
    <span class="n">Ra_L</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">delta_T</span> <span class="o">*</span> <span class="n">L</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">nu</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Pr</span>

    <span class="c1"># Churchill &amp; Chu correlation</span>
    <span class="n">Nu_L</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.825</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.387</span> <span class="o">*</span> <span class="n">Ra_L</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.492</span><span class="o">/</span><span class="n">Pr</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">9</span><span class="o">/</span><span class="mi">16</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="mi">27</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">h_cp</span> <span class="o">=</span> <span class="n">Nu_L</span> <span class="o">*</span> <span class="n">k_air</span> <span class="o">/</span> <span class="n">L</span>  <span class="c1"># [W/m²K]</span>
    
    <span class="k">return</span> <span class="n">h_cp</span></div>



<div class="viewcode-block" id="linear_function">
<a class="viewcode-back" href="../../api/utilities.html#enex_analysis_engine.enex_engine.linear_function">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">linear_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Linear function: y = a*x + b&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">quadratic_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Quadratic function: y = a*x² + b*x + c&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">c</span>


<span class="k">def</span><span class="w"> </span><span class="nf">cubic_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cubic function: y = a*x³ + b*x² + c*x + d&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">d</span>


<span class="k">def</span><span class="w"> </span><span class="nf">quartic_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Quartic function: y = a*x⁴ + b*x³ + c*x² + d*x + e&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">e</span>


<div class="viewcode-block" id="print_balance">
<a class="viewcode-back" href="../../api/utilities.html#enex_analysis_engine.enex_engine.print_balance">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_balance</span><span class="p">(</span><span class="n">balance</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print energy, entropy, or exergy balance dictionary in a formatted way.</span>
<span class="sd">    </span>
<span class="sd">    This function prints balance information for subsystems, categorizing entries</span>
<span class="sd">    into in, out, consumed, and generated categories.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    balance : dict</span>
<span class="sd">        Dictionary containing balance information for subsystems.</span>
<span class="sd">        Structure: {subsystem_name: {category: {symbol: value}}}</span>
<span class="sd">        Categories: &#39;in&#39;, &#39;out&#39;, &#39;con&#39; (consumed), &#39;gen&#39; (generated)</span>
<span class="sd">    decimal : int, optional</span>
<span class="sd">        Number of decimal places for output (default: 2)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Only prints output</span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; balance = {</span>
<span class="sd">    ...     &quot;hot water tank&quot;: {</span>
<span class="sd">    ...         &quot;in&quot;: {&quot;E_heater&quot;: 5000.0},</span>
<span class="sd">    ...         &quot;out&quot;: {&quot;Q_w_tank&quot;: 4500.0, &quot;Q_l_tank&quot;: 400.0},</span>
<span class="sd">    ...         &quot;con&quot;: {&quot;X_c_tank&quot;: 100.0}</span>
<span class="sd">    ...     }</span>
<span class="sd">    ... }</span>
<span class="sd">    &gt;&gt;&gt; print_balance(balance)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_length</span> <span class="o">=</span> <span class="mi">50</span>
    
    <span class="n">balance_type</span> <span class="o">=</span> <span class="s2">&quot;energy&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;[W]&quot;</span>
    
    <span class="c1"># Determine balance type and unit from dictionary structure</span>
    <span class="k">for</span> <span class="n">subsystem</span><span class="p">,</span> <span class="n">category_dict</span> <span class="ow">in</span> <span class="n">balance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">terms</span> <span class="ow">in</span> <span class="n">category_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;gen&quot;</span> <span class="ow">in</span> <span class="n">category</span><span class="p">:</span>
                <span class="n">balance_type</span> <span class="o">=</span> <span class="s2">&quot;entropy&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;[W/K]&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;con&quot;</span> <span class="ow">in</span> <span class="n">category</span><span class="p">:</span>
                <span class="n">balance_type</span> <span class="o">=</span> <span class="s2">&quot;exergy&quot;</span>
    
    <span class="c1"># Print balance for each subsystem</span>
    <span class="k">for</span> <span class="n">subsystem</span><span class="p">,</span> <span class="n">category_dict</span> <span class="ow">in</span> <span class="n">balance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subsystem</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">balance_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> BALANCE:&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">total_length</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span>
        
        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">terms</span> <span class="ow">in</span> <span class="n">category_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">category</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ENTRIES:&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">decimal</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="calculate_ASHP_cooling_COP">
<a class="viewcode-back" href="../../api/utilities.html#enex_analysis_engine.enex_engine.calculate_ASHP_cooling_COP">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_ASHP_cooling_COP</span><span class="p">(</span><span class="n">T_a_int_out</span><span class="p">,</span> <span class="n">T_a_ext_in</span><span class="p">,</span> <span class="n">Q_r_int</span><span class="p">,</span> <span class="n">Q_r_max</span><span class="p">,</span> <span class="n">COP_ref</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Coefficient of Performance (COP) for an Air Source Heat Pump (ASHP) in cooling mode.</span>
<span class="sd">    </span>
<span class="sd">    Reference: https://publications.ibpsa.org/proceedings/bs/2023/papers/bs2023_1118.pdf</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    T_a_int_out : float</span>
<span class="sd">        Indoor air temperature [K]</span>
<span class="sd">    T_a_ext_in : float</span>
<span class="sd">        Outdoor air temperature [K]</span>
<span class="sd">    Q_r_int : float</span>
<span class="sd">        Indoor heat load [W]</span>
<span class="sd">    Q_r_max : float</span>
<span class="sd">        Maximum cooling capacity [W]</span>
<span class="sd">    COP_ref : float</span>
<span class="sd">        Reference COP at standard conditions</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        COP value</span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    COP is calculated based on:</span>
<span class="sd">    - PLR: Part Load Ratio</span>
<span class="sd">    - EIR: Energy input to cooling output ratio</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PLR</span> <span class="o">=</span> <span class="n">Q_r_int</span> <span class="o">/</span> <span class="n">Q_r_max</span>
    <span class="k">if</span> <span class="n">PLR</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
        <span class="n">PLR</span> <span class="o">=</span> <span class="mf">0.2</span>    
    <span class="n">EIR_by_T</span> <span class="o">=</span> <span class="mf">0.38</span> <span class="o">+</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="n">cu</span><span class="o">.</span><span class="n">K2C</span><span class="p">(</span><span class="n">T_a_int_out</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">cu</span><span class="o">.</span><span class="n">K2C</span><span class="p">(</span><span class="n">T_a_ext_in</span><span class="p">)</span>
    <span class="n">EIR_by_PLR</span> <span class="o">=</span> <span class="mf">0.22</span> <span class="o">+</span> <span class="mf">0.50</span> <span class="o">*</span> <span class="n">PLR</span> <span class="o">+</span> <span class="mf">0.26</span> <span class="o">*</span> <span class="n">PLR</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">COP</span> <span class="o">=</span> <span class="n">PLR</span> <span class="o">*</span> <span class="n">COP_ref</span> <span class="o">/</span> <span class="p">(</span><span class="n">EIR_by_T</span> <span class="o">*</span> <span class="n">EIR_by_PLR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">COP</span></div>



<div class="viewcode-block" id="calculate_ASHP_heating_COP">
<a class="viewcode-back" href="../../api/utilities.html#enex_analysis_engine.enex_engine.calculate_ASHP_heating_COP">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_ASHP_heating_COP</span><span class="p">(</span><span class="n">T0</span><span class="p">,</span> <span class="n">Q_r_int</span><span class="p">,</span> <span class="n">Q_r_max</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Coefficient of Performance (COP) for an Air Source Heat Pump (ASHP) in heating mode.</span>
<span class="sd">    </span>
<span class="sd">    Reference: https://www.mdpi.com/2071-1050/15/3/1880</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    T0 : float</span>
<span class="sd">        Environmental temperature [K]</span>
<span class="sd">    Q_r_int : float</span>
<span class="sd">        Indoor heat load [W]</span>
<span class="sd">    Q_r_max : float</span>
<span class="sd">        Maximum heating capacity [W]</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        COP value</span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    COP is calculated based on PLR (Part Load Ratio).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PLR</span> <span class="o">=</span> <span class="n">Q_r_int</span> <span class="o">/</span> <span class="n">Q_r_max</span>
    <span class="k">if</span> <span class="n">PLR</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
        <span class="n">PLR</span> <span class="o">=</span> <span class="mf">0.2</span>    
    <span class="n">COP</span> <span class="o">=</span> <span class="o">-</span><span class="mf">7.46</span> <span class="o">*</span> <span class="p">(</span><span class="n">PLR</span> <span class="o">-</span> <span class="mf">0.0047</span> <span class="o">*</span> <span class="n">cu</span><span class="o">.</span><span class="n">K2C</span><span class="p">(</span><span class="n">T0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.477</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.0941</span> <span class="o">*</span> <span class="n">cu</span><span class="o">.</span><span class="n">K2C</span><span class="p">(</span><span class="n">T0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">4.34</span>
    <span class="k">return</span> <span class="n">COP</span></div>



<div class="viewcode-block" id="calculate_GSHP_COP">
<a class="viewcode-back" href="../../api/utilities.html#enex_analysis_engine.enex_engine.calculate_GSHP_COP">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_GSHP_COP</span><span class="p">(</span><span class="n">Tg</span><span class="p">,</span> <span class="n">T_cond</span><span class="p">,</span> <span class="n">T_evap</span><span class="p">,</span> <span class="n">theta_hat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Carnot-based COP of a GSHP system using the modified formula.</span>
<span class="sd">    </span>
<span class="sd">    Reference: https://www.sciencedirect.com/science/article/pii/S0360544219304347?via%3Dihub</span>
<span class="sd">    </span>
<span class="sd">    Formula: COP = 1 / (1 - T0/T_cond + ΔT * θ̂ / T_cond)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Tg : float</span>
<span class="sd">        Undisturbed ground temperature [K]</span>
<span class="sd">    T_cond : float</span>
<span class="sd">        Condenser refrigerant temperature [K]</span>
<span class="sd">    T_evap : float</span>
<span class="sd">        Evaporator refrigerant temperature [K]</span>
<span class="sd">    theta_hat : float</span>
<span class="sd">        θ̂(x0, k_sb), dimensionless average fluid temperature</span>
<span class="sd">        Reference: Paper Fig 8, Table 1</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Modified Carnot-based COP. Returns NaN if denominator &lt;= 0.</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If T_cond &lt;= T_evap (invalid for COP calculation)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Temperature difference (ΔT = T0 - T1)</span>
    <span class="k">if</span> <span class="n">T_cond</span> <span class="o">&lt;=</span> <span class="n">T_evap</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;T_cond must be greater than T_evap for a valid COP calculation.&quot;</span><span class="p">)</span>
    
    <span class="n">delta_T</span> <span class="o">=</span> <span class="n">Tg</span> <span class="o">-</span> <span class="n">T_evap</span>

    <span class="c1"># Compute COP using the modified Carnot expression</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">Tg</span> <span class="o">/</span> <span class="n">T_cond</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta_T</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_cond</span> <span class="o">*</span> <span class="n">theta_hat</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">denominator</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>  <span class="c1"># Avoid division by zero or negative COP</span>

    <span class="n">COP</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">denominator</span>
    <span class="k">return</span> <span class="n">COP</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for G-function calculation.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    x : float</span>
<span class="sd">        Input value</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        f(x) = x*erf(x) - (1-exp(-x²))/√π</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">erf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">SP</span>


<span class="k">def</span><span class="w"> </span><span class="nf">chi</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for G-function calculation.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    s : float</span>
<span class="sd">        Integration variable</span>
<span class="sd">    rb : float</span>
<span class="sd">        Borehole radius [m]</span>
<span class="sd">    H : float</span>
<span class="sd">        Borehole height [m]</span>
<span class="sd">    z0 : float, optional</span>
<span class="sd">        Reference depth [m] (default: 0)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        chi function value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">H</span> <span class="o">*</span> <span class="n">s</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">*</span> <span class="n">s</span>
    
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">rb</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">Is</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">f</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">f</span><span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">d</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">temp</span> <span class="o">*</span> <span class="n">Is</span>


<span class="n">_g_func_cache</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">G_FLS</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">as_</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the g-function for finite line source (FLS) model.</span>
<span class="sd">    </span>
<span class="sd">    This function calculates the g-function used in ground source heat pump</span>
<span class="sd">    analysis. Results are cached for performance.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    t : float</span>
<span class="sd">        Time [s]</span>
<span class="sd">    ks : float</span>
<span class="sd">        Ground thermal conductivity [W/mK]</span>
<span class="sd">    as_ : float</span>
<span class="sd">        Ground thermal diffusivity [m²/s]</span>
<span class="sd">    rb : float</span>
<span class="sd">        Borehole radius [m]</span>
<span class="sd">    H : float</span>
<span class="sd">        Borehole height [m]</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float or array</span>
<span class="sd">        g-function value [mK/W]. Returns scalar for single time value,</span>
<span class="sd">        array for multiple time values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">as_</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">rb</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_g_func_cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_g_func_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ks</span><span class="p">)</span>
    
    <span class="n">lbs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">as_</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
    
    <span class="c1"># Handle scalar case: shape == (,)</span>
    <span class="n">single</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lbs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c1"># Reshape to 1D array</span>
    <span class="n">lbs</span> <span class="o">=</span> <span class="n">lbs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="c1"># Pre-calculate integral from 0 to inf</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">rb</span><span class="p">,</span> <span class="n">H</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># ODE initial value</span>
    <span class="n">first</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lbs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">rb</span><span class="p">,</span> <span class="n">H</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
   
    <span class="c1"># Scipy ODE solver function form: dydx = f(y, x)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">chi</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">values</span> <span class="o">=</span> <span class="n">total</span> <span class="o">-</span> <span class="n">integrate</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">lbs</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># For single time value, return first value as float</span>
    <span class="k">if</span> <span class="n">single</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">values</span>
    <span class="n">_g_func_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">air_dynamic_viscosity</span><span class="p">(</span><span class="n">T_K</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate air dynamic viscosity using Sutherland&#39;s formula.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    T_K : float</span>
<span class="sd">        Temperature [K]</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        Dynamic viscosity [Pa·s]</span>
<span class="sd">    </span>
<span class="sd">    Reference: Sutherland&#39;s formula for air</span>
<span class="sd">    mu = mu0 * (T/T0)^1.5 * (T0 + S) / (T + S)</span>
<span class="sd">    where mu0 = 1.716e-5 Pa·s at T0 = 273.15 K, S = 110.4 K</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">T0</span> <span class="o">=</span> <span class="mf">273.15</span>  <span class="c1"># Reference temperature [K]</span>
    <span class="n">mu0</span> <span class="o">=</span> <span class="mf">1.716e-5</span>  <span class="c1"># Reference viscosity [Pa·s] at T0</span>
    <span class="n">S</span> <span class="o">=</span> <span class="mf">110.4</span>  <span class="c1"># Sutherland constant [K] for air</span>
    
    <span class="n">mu</span> <span class="o">=</span> <span class="n">mu0</span> <span class="o">*</span> <span class="p">((</span><span class="n">T_K</span> <span class="o">/</span> <span class="n">T0</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">T0</span> <span class="o">+</span> <span class="n">S</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_K</span> <span class="o">+</span> <span class="n">S</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mu</span>


<span class="k">def</span><span class="w"> </span><span class="nf">air_prandtl_number</span><span class="p">(</span><span class="n">T_K</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate air Prandtl number.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    T_K : float</span>
<span class="sd">        Temperature [K]</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        Prandtl number [-]</span>
<span class="sd">    </span>
<span class="sd">    Note: Pr ≈ 0.71 for air at typical temperatures (20-50°C)</span>
<span class="sd">    Temperature dependence is weak, so using constant value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Pr = mu * cp / k</span>
    <span class="c1"># For air: Pr ≈ 0.71 (weak temperature dependence)</span>
    <span class="k">return</span> <span class="mf">0.71</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calc_simple_tank_UA</span><span class="p">(</span>
        <span class="c1"># Tank size [m]</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">H</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="c1"># Tank layer thickness [m]</span>
        <span class="n">x_shell</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">x_ins</span>   <span class="o">=</span> <span class="mf">0.10</span><span class="p">,</span>
        <span class="c1"># Tank thermal conductivity [W/mK]</span>
        <span class="n">k_shell</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>  
        <span class="n">k_ins</span>   <span class="o">=</span> <span class="mf">0.03</span><span class="p">,</span>
        <span class="c1"># External convective heat transfer coefficient [W/m²K]</span>
        <span class="n">h_o</span>     <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate simple tank UA value.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    r0 : float</span>
<span class="sd">        Tank radius [m]</span>
<span class="sd">    H : float</span>
<span class="sd">        Tank height [m]</span>
<span class="sd">    x_shell : float</span>
<span class="sd">        Shell thickness [m]</span>
<span class="sd">    x_ins : float</span>
<span class="sd">        Insulation thickness [m]</span>
<span class="sd">    k_shell : float</span>
<span class="sd">        Shell thermal conductivity [W/mK]</span>
<span class="sd">    k_ins : float</span>
<span class="sd">        Insulation thermal conductivity [W/mK]</span>
<span class="sd">    h_o : float</span>
<span class="sd">        External convective heat transfer coefficient [W/m²K]</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        Tank UA value [W/K]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">x_shell</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">x_ins</span>
    
    <span class="c1"># Tank surface areas [m²]</span>
    <span class="n">A_side</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r2</span> <span class="o">*</span> <span class="n">H</span>
    <span class="n">A_base</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r0</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">R_base_unit</span> <span class="o">=</span> <span class="n">x_shell</span> <span class="o">/</span> <span class="n">k_shell</span> <span class="o">+</span> <span class="n">x_ins</span> <span class="o">/</span> <span class="n">k_ins</span> <span class="c1"># [m2K/W]</span>
    <span class="n">R_side_unit</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r1</span> <span class="o">/</span> <span class="n">r0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k_shell</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r2</span> <span class="o">/</span> <span class="n">r1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k_ins</span><span class="p">)</span> <span class="c1"># [mK/W]</span>
    
    <span class="c1"># Thermal resistances [K/W]</span>
    <span class="n">R_base</span> <span class="o">=</span> <span class="n">R_base_unit</span> <span class="o">/</span> <span class="n">A_base</span> <span class="c1"># [K/W]</span>
    <span class="n">R_side</span> <span class="o">=</span> <span class="n">R_side_unit</span> <span class="o">/</span> <span class="n">H</span> <span class="c1"># [K/W]</span>
    
    <span class="c1"># Thermal resistances [K/W]</span>
    <span class="n">R_base_ext</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">h_o</span> <span class="o">*</span> <span class="n">A_base</span><span class="p">)</span>
    <span class="n">R_side_ext</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">h_o</span> <span class="o">*</span> <span class="n">A_side</span><span class="p">)</span>

    <span class="c1"># Total thermal resistances [K/W]</span>
    <span class="n">R_base_tot</span> <span class="o">=</span> <span class="n">R_base</span> <span class="o">+</span> <span class="n">R_base_ext</span>
    <span class="n">R_side_tot</span> <span class="o">=</span> <span class="n">R_side</span> <span class="o">+</span> <span class="n">R_side_ext</span>

    <span class="c1"># U-value [W/K]</span>
    <span class="n">U_tank</span> <span class="o">=</span> <span class="mi">2</span><span class="o">/</span><span class="n">R_base_tot</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">R_side_tot</span> 
    <span class="k">return</span> <span class="n">U_tank</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calc_lmtd_counter_flow</span><span class="p">(</span><span class="n">T_hot_in_K</span><span class="p">,</span> <span class="n">T_hot_out_K</span><span class="p">,</span> <span class="n">T_cold_in_K</span><span class="p">,</span> <span class="n">T_cold_out_K</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate LMTD for counter-flow heat exchanger.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    T_hot_in_K : float</span>
<span class="sd">        Hot fluid inlet temperature [K]</span>
<span class="sd">    T_hot_out_K : float</span>
<span class="sd">        Hot fluid outlet temperature [K]</span>
<span class="sd">    T_cold_in_K : float</span>
<span class="sd">        Cold fluid inlet temperature [K]</span>
<span class="sd">    T_cold_out_K : float</span>
<span class="sd">        Cold fluid outlet temperature [K]</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        LMTD [K]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Counter-flow: hot inlet ↔ cold outlet, hot outlet ↔ cold inlet</span>
    <span class="n">dT1</span> <span class="o">=</span> <span class="n">T_hot_in_K</span> <span class="o">-</span> <span class="n">T_cold_out_K</span>
    <span class="n">dT2</span> <span class="o">=</span> <span class="n">T_hot_out_K</span> <span class="o">-</span> <span class="n">T_cold_in_K</span>
    
    <span class="k">if</span> <span class="n">dT1</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dT2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dT1</span> <span class="o">-</span> <span class="n">dT2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">dT1</span> <span class="o">+</span> <span class="n">dT2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">dT1</span> <span class="o">-</span> <span class="n">dT2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dT1</span> <span class="o">/</span> <span class="n">dT2</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calc_lmtd_parallel_flow</span><span class="p">(</span><span class="n">T_hot_in_K</span><span class="p">,</span> <span class="n">T_hot_out_K</span><span class="p">,</span> <span class="n">T_cold_in_K</span><span class="p">,</span> <span class="n">T_cold_out_K</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate LMTD for parallel-flow heat exchanger.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    T_hot_in_K : float</span>
<span class="sd">        Hot fluid inlet temperature [K]</span>
<span class="sd">    T_hot_out_K : float</span>
<span class="sd">        Hot fluid outlet temperature [K]</span>
<span class="sd">    T_cold_in_K : float</span>
<span class="sd">        Cold fluid inlet temperature [K]</span>
<span class="sd">    T_cold_out_K : float</span>
<span class="sd">        Cold fluid outlet temperature [K]</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        LMTD [K]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parallel-flow: hot inlet ↔ cold inlet, hot outlet ↔ cold outlet</span>
    <span class="n">dT1</span> <span class="o">=</span> <span class="n">T_hot_in_K</span> <span class="o">-</span> <span class="n">T_cold_in_K</span>
    <span class="n">dT2</span> <span class="o">=</span> <span class="n">T_hot_out_K</span> <span class="o">-</span> <span class="n">T_cold_out_K</span>
    
    <span class="k">if</span> <span class="n">dT1</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dT2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dT1</span> <span class="o">-</span> <span class="n">dT2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">dT1</span> <span class="o">+</span> <span class="n">dT2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">dT1</span> <span class="o">-</span> <span class="n">dT2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dT1</span> <span class="o">/</span> <span class="n">dT2</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calc_lmtd_fluid_and_constant_temp</span><span class="p">(</span><span class="n">T_constant_K</span><span class="p">,</span> <span class="n">T_fluid_in_K</span><span class="p">,</span> <span class="n">T_fluid_out_K</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate LMTD when one fluid maintains constant temperature.</span>
<span class="sd">    </span>
<span class="sd">    One fluid maintains a constant temperature (e.g., during phase change),</span>
<span class="sd">    while the other fluid temperature changes from inlet to outlet.</span>
<span class="sd">    This applies to condensers, evaporators, or any heat exchanger where</span>
<span class="sd">    one fluid undergoes phase change or maintains constant temperature.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    T_constant_K : float</span>
<span class="sd">        Constant temperature of one fluid [K]</span>
<span class="sd">    T_fluid_in_K : float</span>
<span class="sd">        Inlet temperature of the other fluid [K]</span>
<span class="sd">    T_fluid_out_K : float</span>
<span class="sd">        Outlet temperature of the other fluid [K]</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        LMTD [K]</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - Since one fluid temperature is constant, LMTD is calculated in simplified form.</span>
<span class="sd">    - Q&gt;0 (constant temp fluid releases heat): T_constant &gt; T_fluid_in, T_constant &gt; T_fluid_out</span>
<span class="sd">      → dT_in = T_constant - T_fluid_in, dT_out = T_constant - T_fluid_out</span>
<span class="sd">    - Q&lt;0 (constant temp fluid absorbs heat): T_constant &lt; T_fluid_in, T_constant &lt; T_fluid_out</span>
<span class="sd">      → dT_in = T_fluid_in - T_constant, dT_out = T_fluid_out - T_constant</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Temperature difference calculation (maintain sign)</span>
    <span class="n">dT_in</span> <span class="o">=</span> <span class="n">T_constant_K</span> <span class="o">-</span> <span class="n">T_fluid_in_K</span>
    <span class="n">dT_out</span> <span class="o">=</span> <span class="n">T_constant_K</span> <span class="o">-</span> <span class="n">T_fluid_out_K</span>
    
    <span class="c1"># Physical validity check: dT_in and dT_out must have same sign</span>
    <span class="k">if</span> <span class="n">dT_in</span> <span class="o">*</span> <span class="n">dT_out</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Constant temperature is between fluid inlet and outlet (physically impossible)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="c1"># Calculate LMTD using absolute values</span>
    <span class="n">dT_in_abs</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dT_in</span><span class="p">)</span>
    <span class="n">dT_out_abs</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dT_out</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">dT_in_abs</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dT_out_abs</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="c1"># LMTD calculation</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dT_in_abs</span> <span class="o">-</span> <span class="n">dT_out_abs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">dT_in_abs</span> <span class="o">+</span> <span class="n">dT_out_abs</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">dT_in_abs</span> <span class="o">-</span> <span class="n">dT_out_abs</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dT_in_abs</span> <span class="o">/</span> <span class="n">dT_out_abs</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calc_UA_from_dV_fan</span><span class="p">(</span><span class="n">dV_fan</span><span class="p">,</span> <span class="n">dV_fan_design</span><span class="p">,</span> <span class="n">A_cross</span><span class="p">,</span> <span class="n">UA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate heat transfer coefficient based on Dittus-Boelter equation.</span>
<span class="sd">    </span>
<span class="sd">    This function calculates heat transfer coefficient based on air velocity.</span>
<span class="sd">    Dittus-Boelter equation: Nu = 0.023 * Re^0.8 * Pr^n</span>
<span class="sd">    Proportional to velocity^0.8.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    dV_fan : float</span>
<span class="sd">        Fan flow rate [m³/s]</span>
<span class="sd">    dV_fan_design : float</span>
<span class="sd">        Design fan flow rate [m³/s]</span>
<span class="sd">    A_cross : float</span>
<span class="sd">        Heat exchanger cross-sectional area [m²]</span>
<span class="sd">    UA : float</span>
<span class="sd">        Refrigerant-side resistance and correction factor [W/K]</span>
<span class="sd">        Coefficient for Dittus-Boelter equation, U = UA * V^0.8 form</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        Overall heat transfer coefficient U [W/K]</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - Velocity calculation: v = dV_fan / A_cross</span>
<span class="sd">    - Heat transfer coefficient: U = UA * v^0.8</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Velocity calculation</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">dV_fan</span> <span class="o">/</span> <span class="n">A_cross</span> <span class="k">if</span> <span class="n">A_cross</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">v_design</span> <span class="o">=</span> <span class="n">dV_fan_design</span> <span class="o">/</span> <span class="n">A_cross</span> <span class="k">if</span> <span class="n">A_cross</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">UA</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="n">v_design</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.8</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calc_HX_perf_for_target_heat</span><span class="p">(</span><span class="n">Q_ref_target</span><span class="p">,</span> <span class="n">T_air_in_C</span><span class="p">,</span> <span class="n">T_ref_avg_K</span><span class="p">,</span> <span class="n">A_cross</span><span class="p">,</span> <span class="n">UA_design</span><span class="p">,</span> <span class="n">dV_fan_design</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Numerically solve for the air-side flow rate (fan airflow) required to achieve a target heat transfer rate in a heat exchanger, using a dynamically varying UA based on air velocity.</span>

<span class="sd">    This function determines the airflow that is needed to meet a specified heat transfer demand, accounting for dynamic changes in the overall heat transfer coefficient (UA) as a function of flow velocity using the Dittus-Boelter relationship (UA ∝ velocity^0.8).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Q_ref_target : float</span>
<span class="sd">        Target heat transfer rate between refrigerant and air [W].</span>
<span class="sd">        Positive (+): Heat transferred from refrigerant to air (heating mode).</span>
<span class="sd">        Negative (−): Heat transferred from air to refrigerant (cooling mode).</span>

<span class="sd">    T_air_in_C : float</span>
<span class="sd">        Inlet temperature of air [°C].</span>

<span class="sd">    T_ref_avg_K : float</span>
<span class="sd">        Average refrigerant temperature used as the constant-temperature side [K].</span>
<span class="sd">        Typically the mean of refrigerant inlet and outlet temperatures.</span>

<span class="sd">    A_cross : float</span>
<span class="sd">        Heat exchanger cross-sectional area for airflow [m²].</span>

<span class="sd">    UA_design : float</span>
<span class="sd">        Design overall heat transfer coefficient at design flow rate [W/K].</span>

<span class="sd">    dV_fan_design : float</span>
<span class="sd">        Design fan flow rate [m³/s]. Used for velocity normalization.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing:</span>
<span class="sd">            - dV_fan : Required air-side flow rate [m³/s]</span>
<span class="sd">            - UA : Actual heat exchanger overall heat transfer coefficient at solution point [W/K]</span>
<span class="sd">            - T_air_out_K : Outlet air temperature [K]</span>
<span class="sd">            - LMTD : Log-mean temperature difference at operating point [K]</span>
<span class="sd">            - Q_LMTD : Heat transfer rate at operating point [W]</span>
<span class="sd">            - epsilon : Effectiveness at operating point [–]</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Air-side UA is dynamically updated using Dittus-Boelter scaling at each iterative guess.</span>
<span class="sd">    - LMTD is computed assuming one side stays at constant temperature (refrigerant avg).</span>
<span class="sd">    - The solution applies to both air-source heat pump condenser and evaporator, depending on Q_ref_target sign.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># All arguments are required. UA is always calculated using UA_design and velocity correction in this version.</span>
    
    <span class="n">T_air_in_K</span> <span class="o">=</span> <span class="n">cu</span><span class="o">.</span><span class="n">C2K</span><span class="p">(</span><span class="n">T_air_in_C</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_error_function</span><span class="p">(</span><span class="n">dV_fan</span><span class="p">):</span>
        <span class="n">UA</span> <span class="o">=</span> <span class="n">calc_UA_from_dV_fan</span><span class="p">(</span><span class="n">dV_fan</span><span class="p">,</span> <span class="n">dV_fan_design</span><span class="p">,</span> <span class="n">A_cross</span><span class="p">,</span> <span class="n">UA_design</span><span class="p">)</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">UA</span> <span class="o">/</span> <span class="p">(</span><span class="n">c_a</span> <span class="o">*</span> <span class="n">rho_a</span> <span class="o">*</span> <span class="n">dV_fan</span><span class="p">))</span>
        <span class="n">T_air_out_K</span> <span class="o">=</span> <span class="n">T_air_in_K</span> <span class="o">+</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_ref_avg_K</span> <span class="o">-</span> <span class="n">T_air_in_K</span><span class="p">)</span> <span class="c1"># Heating assumption (Q_ref_target &gt; 0)</span>
            
        <span class="n">LMTD</span> <span class="o">=</span> <span class="n">calc_lmtd_fluid_and_constant_temp</span><span class="p">(</span>
            <span class="n">T_constant_K</span>  <span class="o">=</span> <span class="n">T_ref_avg_K</span><span class="p">,</span>
            <span class="n">T_fluid_in_K</span>  <span class="o">=</span> <span class="n">T_air_in_K</span><span class="p">,</span>
            <span class="n">T_fluid_out_K</span> <span class="o">=</span> <span class="n">T_air_out_K</span>
        <span class="p">)</span>
        <span class="n">Q_LMTD</span> <span class="o">=</span> <span class="n">UA</span> <span class="o">*</span> <span class="n">LMTD</span> <span class="c1"># [W]</span>
        <span class="k">return</span> <span class="n">Q_LMTD</span> <span class="o">-</span> <span class="n">Q_ref_target</span>

    <span class="n">dV_min</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># [m³/s]</span>
    <span class="n">dV_max</span> <span class="o">=</span> <span class="n">dV_fan_design</span> <span class="c1"># [m³/s]</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="n">root_scalar</span><span class="p">(</span><span class="n">_error_function</span><span class="p">,</span> <span class="n">bracket</span><span class="o">=</span><span class="p">[</span><span class="n">dV_min</span><span class="p">,</span> <span class="n">dV_max</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bisect&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
        <span class="c1"># 수렴된 dV_fan 값을 사용하여 최종 값들 계산</span>
        <span class="n">dV_fan_converged</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">root</span>
        <span class="n">UA</span> <span class="o">=</span> <span class="n">calc_UA_from_dV_fan</span><span class="p">(</span><span class="n">dV_fan_converged</span><span class="p">,</span> <span class="n">dV_fan_design</span><span class="p">,</span> <span class="n">A_cross</span><span class="p">,</span> <span class="n">UA_design</span><span class="p">)</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">UA</span> <span class="o">/</span> <span class="p">(</span><span class="n">c_a</span> <span class="o">*</span> <span class="n">rho_a</span> <span class="o">*</span> <span class="n">dV_fan_converged</span><span class="p">))</span>
        <span class="n">T_air_out_K</span> <span class="o">=</span> <span class="n">T_air_in_K</span> <span class="o">+</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_ref_avg_K</span> <span class="o">-</span> <span class="n">T_air_in_K</span><span class="p">)</span>  <span class="c1"># Heating assumption (Q_ref_target &gt; 0)</span>
        <span class="n">LMTD</span> <span class="o">=</span> <span class="n">calc_lmtd_fluid_and_constant_temp</span><span class="p">(</span>
            <span class="n">T_constant_K</span>  <span class="o">=</span> <span class="n">T_ref_avg_K</span><span class="p">,</span>
            <span class="n">T_fluid_in_K</span>  <span class="o">=</span> <span class="n">T_air_in_K</span><span class="p">,</span>
            <span class="n">T_fluid_out_K</span> <span class="o">=</span> <span class="n">T_air_out_K</span>
        <span class="p">)</span>
        <span class="n">Q_LMTD</span> <span class="o">=</span> <span class="n">UA</span> <span class="o">*</span> <span class="n">LMTD</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;dV_fan&#39;</span><span class="p">:</span> <span class="n">dV_fan_converged</span><span class="p">,</span>
            <span class="s1">&#39;UA&#39;</span><span class="p">:</span> <span class="n">UA</span><span class="p">,</span>
            <span class="s1">&#39;T_air_out_K&#39;</span><span class="p">:</span> <span class="n">T_air_out_K</span><span class="p">,</span>
            <span class="s1">&#39;LMTD&#39;</span><span class="p">:</span> <span class="n">LMTD</span><span class="p">,</span>
            <span class="s1">&#39;Q_LMTD&#39;</span><span class="p">:</span> <span class="n">Q_LMTD</span><span class="p">,</span>
            <span class="s1">&#39;epsilon&#39;</span><span class="p">:</span> <span class="n">epsilon</span><span class="p">,</span>
            <span class="s1">&#39;converged&#39;</span><span class="p">:</span> <span class="kc">True</span>  <span class="c1"># 명시적으로 converged 플래그 추가</span>
            <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;converged&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;dV_fan&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s1">&#39;UA&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s1">&#39;T_air_out_K&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s1">&#39;LMTD&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s1">&#39;Q_LMTD&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s1">&#39;epsilon&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calc_fan_power_from_dV_fan</span><span class="p">(</span><span class="n">dV_fan</span><span class="p">,</span> <span class="n">fan_params</span><span class="p">,</span> <span class="n">vsd_coeffs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate fan power using ASHRAE 90.1 VSD Curve.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    dV_fan : float</span>
<span class="sd">        Current flow rate [m³/s]</span>
<span class="sd">    fan_params : dict</span>
<span class="sd">        Fan parameters (fan_design_flow_rate, fan_design_power)</span>
<span class="sd">    vsd_coeffs : dict</span>
<span class="sd">        VSD Curve coefficients (c1~c5)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        Fan power [W]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract design parameters</span>
    <span class="n">fan_design_flow_rate</span> <span class="o">=</span> <span class="n">fan_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fan_design_flow_rate&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">fan_design_power</span> <span class="o">=</span> <span class="n">fan_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fan_design_power&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    
    <span class="c1"># Error if design parameters are missing</span>
    <span class="k">if</span> <span class="n">fan_design_flow_rate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fan_design_power</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fan_design_flow_rate and fan_design_power must be provided in fan_params&quot;</span><span class="p">)</span>
    
    <span class="c1"># Flow rate validation</span>
    <span class="k">if</span> <span class="n">dV_fan</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fan flow rate must be greater than 0: </span><span class="si">{</span><span class="n">dV_fan</span><span class="si">}</span><span class="s2"> [m³/s]&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fan flow rate must be greater than 0&quot;</span><span class="p">)</span>
    
    <span class="c1"># Extract VSD Curve coefficients</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">vsd_coeffs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="mf">0.0013</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">vsd_coeffs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="mf">0.1470</span><span class="p">)</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="n">vsd_coeffs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c3&#39;</span><span class="p">,</span> <span class="mf">0.9506</span><span class="p">)</span>
    <span class="n">c4</span> <span class="o">=</span> <span class="n">vsd_coeffs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c4&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0998</span><span class="p">)</span>
    <span class="n">c5</span> <span class="o">=</span> <span class="n">vsd_coeffs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c5&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    
    <span class="c1"># Calculate flow fraction</span>
    <span class="n">flow_fraction</span> <span class="o">=</span> <span class="n">dV_fan</span> <span class="o">/</span> <span class="n">fan_design_flow_rate</span>
    
    <span class="c1"># Calculate Part-load ratio: PLR = c1 + c2*x + c3*x² + c4*x³ + c5*x⁴</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">flow_fraction</span>
    <span class="n">PLR</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c4</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">c5</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">4</span>
    
    <span class="c1"># Ensure PLR is not negative</span>
    <span class="n">PLR</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">PLR</span><span class="p">)</span>
    
    <span class="c1"># Calculate fan power</span>
    <span class="n">fan_power</span> <span class="o">=</span> <span class="n">fan_design_power</span> <span class="o">*</span> <span class="n">PLR</span>
    
    <span class="k">return</span> <span class="n">fan_power</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_build_schedule_ratios</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">t_array</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build schedule ratio array from schedule entries for each timestep (t_array).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    entries : list of tuple</span>
<span class="sd">        Schedule entry list. Each item is (start_str, end_str, frac) format.</span>
<span class="sd">        - start_str, end_str: &quot;H:M&quot; or &quot;H&quot; format string (e.g., &quot;6:00&quot;, &quot;23:30&quot;, &quot;24:00&quot;, etc.).</span>
<span class="sd">          &quot;24:00&quot; is specially handled as end of day (= 24*cu.h2s seconds).</span>
<span class="sd">        - frac: Usage ratio (float) for that interval. Clipped to 0.0 ~ 1.0 range.</span>
<span class="sd">        Intervals are treated as half-open [start, end).</span>

<span class="sd">    t_array : numpy.ndarray</span>
<span class="sd">        Timestep array in seconds (e.g., np.arange(0, sim_seconds, dt)). Each element</span>
<span class="sd">        is mapped to time within the same day using modulo operation with 24*cu.h2s.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Array with same shape as t_array. Schedule ratio (0.0 ~ 1.0) for each timestep.</span>
<span class="sd">        If multiple entries overlap, the value at that position is the maximum of the frac values.</span>

<span class="sd">    Summary</span>
<span class="sd">    -------</span>
<span class="sd">    - Time strings are converted to seconds internally using _time_str_to_sec.</span>
<span class="sd">    - If end is 24*cu.h2s (e.g., &quot;24:00&quot;), it is adjusted to last value before end of day.</span>
<span class="sd">    - If interval crosses midnight (e.g., start=23:00, end=02:00), OR mask is used to</span>
<span class="sd">      correctly cover intervals that cross midnight.</span>
<span class="sd">    - Ratio (frac) is clipped to 0~1 range using np.clip.</span>
<span class="sd">    - Return value is finally clipped to 0~1 range to guarantee bounds.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    entries = [(&quot;6:00&quot;,&quot;7:00&quot;,0.5), (&quot;6:30&quot;,&quot;8:00&quot;,0.8)]</span>
<span class="sd">    -&gt; Interval 6:30~7:00 has max(0.5,0.8)=0.8 applied.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - t_array must be continuous time array in seconds, internally modulo operated with 24*cu.h2s.</span>
<span class="sd">    - When multiple entries exist at same time, priority is maximum frac value (merge instead of overwrite).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">day</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="n">cu</span><span class="o">.</span><span class="n">h2s</span>
    <span class="n">secs_mod</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_array</span> <span class="o">%</span> <span class="n">day</span><span class="p">)</span>
    <span class="n">sched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_time_str_to_sec</span><span class="p">(</span><span class="n">time_str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert time string format (e.g., &quot;H&quot;, &quot;H:M&quot;) to integer seconds within day (0 ~ 86400).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time_str : str</span>
<span class="sd">            Time string in &quot;H&quot; or &quot;H:M&quot; format.</span>
<span class="sd">            - &quot;H&quot; represents hour, integer in 0~24 range.</span>
<span class="sd">            - &quot;H:M&quot; is format with hour and minute separated by colon (:).</span>
<span class="sd">                Hour is 0~24, minute is 0~59 integer.</span>
<span class="sd">            - &quot;24:00&quot; is specially handled as end of day (= 24*cu.h2s seconds).</span>

<span class="sd">        Behavior</span>
<span class="sd">        --------</span>
<span class="sd">        - Separate hour and minute, convert to seconds: seconds = (h % 24) * 3600 + m * 60</span>
<span class="sd">        - If input is &quot;24:00&quot; (string starts with &#39;24&#39; and h%24 == 0), return 24*cu.h2s.</span>
<span class="sd">        - Hour (h) is modulo operated with 24, so notation &gt;= 24 is mapped to 0..23.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Integer seconds within day (0 ~ 86400).</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="n">h</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">])[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">%</span> <span class="mi">24</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">24</span><span class="o">*</span><span class="n">cu</span><span class="o">.</span><span class="n">h2s</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">time_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;24&#39;</span><span class="p">))</span> <span class="k">else</span> <span class="n">h</span><span class="o">*</span><span class="n">cu</span><span class="o">.</span><span class="n">h2s</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="mi">60</span>
        
    <span class="c1"># Process schedule entries</span>
    <span class="k">for</span> <span class="n">start_str</span><span class="p">,</span> <span class="n">end_str</span><span class="p">,</span> <span class="n">frac</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_time_str_to_sec</span><span class="p">(</span><span class="n">start_str</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">_time_str_to_sec</span><span class="p">(</span><span class="n">end_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="mi">24</span><span class="o">*</span><span class="n">cu</span><span class="o">.</span><span class="n">h2s</span><span class="p">:</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="n">cu</span><span class="o">.</span><span class="n">h2s</span> <span class="o">-</span> <span class="mf">1e-9</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">frac</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">e</span><span class="p">:</span> <span class="k">continue</span>
        
        <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">secs_mod</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">secs_mod</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">secs_mod</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">secs_mod</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">sched</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sched</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">ratio</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">sched</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>


<span class="c1"># ============================================================================</span>
<span class="c1"># 히트펌프 사이클 성능 계산 및 최적 운전점 탐색 함수들</span>
<span class="c1"># (cycle_performance.py에서 이동)</span>
<span class="c1"># ============================================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_refrigerant_thermodynamic_states</span><span class="p">(</span>
    <span class="n">T_evap_K</span><span class="p">,</span>  <span class="c1"># 증발 온도 [K]</span>
    <span class="n">T_cond_K</span><span class="p">,</span>  <span class="c1"># 응축 온도 [K]</span>
    <span class="n">refrigerant</span><span class="p">,</span>  <span class="c1"># 냉매 이름</span>
    <span class="n">eta_cmp_isen</span><span class="p">,</span>  <span class="c1"># 압축기 단열 효율</span>
    <span class="n">T0_K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># 기준 온도 [K] (엑서지 계산용, 선택적)</span>
    <span class="n">P0</span><span class="o">=</span><span class="mi">101325</span><span class="p">,</span>  <span class="c1"># 기준 압력 [Pa] (엑서지 계산용, 선택적)</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;heating&#39;</span><span class="p">,</span>  <span class="c1"># 작동 모드 (&#39;heating&#39; 또는 &#39;cooling&#39;)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    냉매 사이클의 State 1-4 열역학 물성치를 계산하는 공통 함수.</span>
<span class="sd">    </span>
<span class="sd">    이 함수는 히트펌프 사이클의 4개 주요 상태점을 계산합니다:</span>
<span class="sd">    </span>
<span class="sd">    난방 모드 (mode=&#39;heating&#39;):</span>
<span class="sd">    - State 1: 압축기 입구 (증발기 출구, 저압 포화 증기)</span>
<span class="sd">    - State 2: 압축기 출구 (응축기 입구, 고압 과열 증기)</span>
<span class="sd">    - State 3: 응축기 출구 (팽창밸브 입구, 고압 포화 액체)</span>
<span class="sd">    - State 4: 팽창밸브 출구 (증발기 입구, 저압 액체+기체 혼합물)</span>
<span class="sd">    </span>
<span class="sd">    냉방 모드 (mode=&#39;cooling&#39;, 4-way 밸브로 인한 역순환):</span>
<span class="sd">    - State 1: 압축기 출구 (응축기 입구, 고압 과열 증기)</span>
<span class="sd">    - State 2: 압축기 입구 (증발기 출구, 저압 포화 증기)</span>
<span class="sd">    - State 3: 팽창밸브 출구 (증발기 입구, 저압 액체+기체 혼합물)</span>
<span class="sd">    - State 4: 응축기 출구 (팽창밸브 입구, 고압 포화 액체)</span>
<span class="sd">    </span>
<span class="sd">    알고리즘:</span>
<span class="sd">    1. 증발기와 응축기 압력 계산 (포화 압력)</span>
<span class="sd">    2. State 1: 저압 포화 증기 상태 계산</span>
<span class="sd">    3. State 2: 단열 압축 후 실제 압축(비단열) 계산</span>
<span class="sd">       - 등엔트로피 압축 후 엔탈피 계산 (이상적)</span>
<span class="sd">       - 압축기 효율을 고려한 실제 엔탈피 계산</span>
<span class="sd">    4. State 3: 고압 포화 액체 상태 계산</span>
<span class="sd">    5. State 4: 등엔탈피 팽창 (h4 = h3) 후 상태 계산</span>
<span class="sd">    </span>
<span class="sd">    호출 관계:</span>
<span class="sd">    - 호출자: _calculate_gshpb_next_step (DHW_main_engine.py)</span>
<span class="sd">    - 호출 함수: CoolProp.PropsSI (냉매 물성 계산)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        - T_evap_K (float): 증발 온도 [K]</span>
<span class="sd">        - T_cond_K (float): 응축 온도 [K]</span>
<span class="sd">        - refrigerant (str): 냉매 이름 (CoolProp 형식, 예: &#39;R410A&#39;)</span>
<span class="sd">        - eta_cmp_isen (float): 압축기 단열 효율 [0-1]</span>
<span class="sd">            - 실제 압축 전력 = 이론 압축 전력 / eta_cmp_isen</span>
<span class="sd">        - T0_K (float, optional): 기준 온도 [K] (엑서지 계산용)</span>
<span class="sd">            - 제공되면 State 1-4의 엑서지 계산 수행</span>
<span class="sd">        - P0 (float, optional): 기준 압력 [Pa] (엑서지 계산용, 기본값: 101325)</span>
<span class="sd">        - mode (str, optional): 작동 모드 (&#39;heating&#39; 또는 &#39;cooling&#39;, 기본값: &#39;heating&#39;)</span>
<span class="sd">            - &#39;heating&#39;: 난방 모드 (기본 계산, State 1=압축기 유입)</span>
<span class="sd">            - &#39;cooling&#39;: 냉방 모드 (4-way 밸브 역순환, State 2=압축기 유입으로 재매핑)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: State 1-4의 물성치를 포함한 딕셔너리</span>
<span class="sd">        - P1, P2, P3, P4: 압력 [Pa] (모드에 따라 물리적 위치에 맞게 재매핑됨)</span>
<span class="sd">        - T1_K, T2_K, T3_K, T4_K: 온도 [K] (모드에 따라 물리적 위치에 맞게 재매핑됨)</span>
<span class="sd">        - h1, h2, h3, h4: 엔탈피 [J/kg] (모드에 따라 물리적 위치에 맞게 재매핑됨)</span>
<span class="sd">        - s1, s2, s3, s4: 엔트로피 [J/kgK] (모드에 따라 물리적 위치에 맞게 재매핑됨)</span>
<span class="sd">        - rho1: 압축기 유입 밀도 [kg/m³] (냉매 유량 계산에 사용)</span>
<span class="sd">        - x1, x2, x3, x4: 엑서지 [J/kg] (T0_K, P0가 제공된 경우, 모드에 따라 재매핑됨)</span>
<span class="sd">        - mode: 계산에 사용된 모드 (&#39;heating&#39; 또는 &#39;cooling&#39;)</span>
<span class="sd">        </span>
<span class="sd">        물리적 위치 매핑:</span>
<span class="sd">        - 난방 모드: h1=압축기 유입, h2=압축기 유출, h3=응축기 출구, h4=팽창밸브 출구</span>
<span class="sd">        - 냉방 모드: h1=압축기 유출, h2=압축기 유입, h3=팽창밸브 출구, h4=응축기 출구 (4-way 밸브 역순환)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">        - 엑서지 계산식: x = (h - h0) - T0 * (s - s0)</span>
<span class="sd">          여기서 (h0, s0)는 기준 상태(T0_K, P0)의 엔탈피와 엔트로피</span>
<span class="sd">        - State 2는 단열 효율을 고려한 실제 압축 과정을 반영</span>
<span class="sd">        - State 4는 등엔탈피 과정 (h4 = h3)으로 팽창밸브를 모델링</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># 1단계: 증발기 및 응축기 압력 계산</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">T_evap_K</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>
    <span class="n">P3</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">T_cond_K</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>
    
    <span class="c1"># 2. State 1 계산 - 압축기 입구 (저압 포화 증기)</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>  <span class="c1"># 엔탈피 [J/kg]</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>  <span class="c1"># 엔트로피 [J/kgK]</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>  <span class="c1"># 밀도 [kg/m³] (냉매 유량 계산용)</span>
    <span class="n">T1_K</span> <span class="o">=</span> <span class="n">T_evap_K</span>  <span class="c1"># 포화 증기이므로 증발 온도와 동일</span>
    
    <span class="c1"># 3. State 2 계산 - 압축기 출구 (고압 과열 증기)</span>
    <span class="n">h2_isen</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>  <span class="c1"># 등엔트로피 압축 후 엔탈피</span>
    
    <span class="n">h2</span> <span class="o">=</span> <span class="n">h1</span> <span class="o">+</span> <span class="p">(</span><span class="n">h2_isen</span> <span class="o">-</span> <span class="n">h1</span><span class="p">)</span> <span class="o">/</span> <span class="n">eta_cmp_isen</span>
    <span class="n">T2_K</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>  <span class="c1"># 과열 온도</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="n">P3</span>  <span class="c1"># 압력은 응축기 압력과 동일</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>  <span class="c1"># 실제 엔트로피 (s1보다 큼)</span>
    
    <span class="c1"># 4. State 3 계산 - 응축기 출구 (고압 포화 액체)</span>
    <span class="n">h3</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>  <span class="c1"># 포화 액체 엔탈피</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>  <span class="c1"># 포화 액체 엔트로피</span>
    <span class="n">T3_K</span> <span class="o">=</span> <span class="n">T_cond_K</span>  <span class="c1"># 포화 액체이므로 응축 온도와 동일</span>
    
    <span class="c1"># 5. State 4 계산 - 팽창밸브 출구 (저압 액체+기체 혼합물)</span>
    <span class="n">h4</span> <span class="o">=</span> <span class="n">h3</span>  <span class="c1"># 등엔탈피 팽창</span>
    <span class="n">P4</span> <span class="o">=</span> <span class="n">P1</span>  <span class="c1"># 압력은 증발기 압력과 동일</span>
    <span class="n">T4_K</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">h4</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>  <span class="c1"># 저압에서 엔탈피 h4에 해당하는 온도</span>
    <span class="n">s4</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">h4</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>  <span class="c1"># 팽창 후 엔트로피</span>
    
    <span class="n">h0</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">T0_K</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P0</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>
    <span class="n">s0</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">T0_K</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">P0</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;cooling&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># 냉방 모드 기준 물성치 (물리적 위치에 따라 재매핑)</span>
            <span class="s1">&#39;P1&#39;</span><span class="p">:</span> <span class="n">P2</span><span class="p">,</span>
            <span class="s1">&#39;P2&#39;</span><span class="p">:</span> <span class="n">P1</span><span class="p">,</span>
            <span class="s1">&#39;P3&#39;</span><span class="p">:</span> <span class="n">P4</span><span class="p">,</span>
            <span class="s1">&#39;P4&#39;</span><span class="p">:</span> <span class="n">P3</span><span class="p">,</span>
            <span class="s1">&#39;T1_K&#39;</span><span class="p">:</span> <span class="n">T2_K</span><span class="p">,</span>
            <span class="s1">&#39;T2_K&#39;</span><span class="p">:</span> <span class="n">T1_K</span><span class="p">,</span>
            <span class="s1">&#39;T3_K&#39;</span><span class="p">:</span> <span class="n">T4_K</span><span class="p">,</span>
            <span class="s1">&#39;T4_K&#39;</span><span class="p">:</span> <span class="n">T3_K</span><span class="p">,</span>
            <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="n">h2</span><span class="p">,</span>
            <span class="s1">&#39;h2&#39;</span><span class="p">:</span> <span class="n">h1</span><span class="p">,</span>
            <span class="s1">&#39;h3&#39;</span><span class="p">:</span> <span class="n">h4</span><span class="p">,</span>
            <span class="s1">&#39;h4&#39;</span><span class="p">:</span> <span class="n">h3</span><span class="p">,</span>
            <span class="s1">&#39;s1&#39;</span><span class="p">:</span> <span class="n">s2</span><span class="p">,</span>
            <span class="s1">&#39;s2&#39;</span><span class="p">:</span> <span class="n">s1</span><span class="p">,</span>
            <span class="s1">&#39;s3&#39;</span><span class="p">:</span> <span class="n">s4</span><span class="p">,</span>
            <span class="s1">&#39;s4&#39;</span><span class="p">:</span> <span class="n">s3</span><span class="p">,</span>
            <span class="s1">&#39;rho&#39;</span><span class="p">:</span> <span class="n">rho</span><span class="p">,</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;cooling&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 난방 모드: 기본 계산값 그대로 사용</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;P1&#39;</span><span class="p">:</span> <span class="n">P1</span><span class="p">,</span>
            <span class="s1">&#39;P2&#39;</span><span class="p">:</span> <span class="n">P2</span><span class="p">,</span>
            <span class="s1">&#39;P3&#39;</span><span class="p">:</span> <span class="n">P3</span><span class="p">,</span>
            <span class="s1">&#39;P4&#39;</span><span class="p">:</span> <span class="n">P4</span><span class="p">,</span>
            <span class="s1">&#39;T1_K&#39;</span><span class="p">:</span> <span class="n">T1_K</span><span class="p">,</span>
            <span class="s1">&#39;T2_K&#39;</span><span class="p">:</span> <span class="n">T2_K</span><span class="p">,</span>
            <span class="s1">&#39;T3_K&#39;</span><span class="p">:</span> <span class="n">T3_K</span><span class="p">,</span>
            <span class="s1">&#39;T4_K&#39;</span><span class="p">:</span> <span class="n">T4_K</span><span class="p">,</span>
            <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="n">h1</span><span class="p">,</span>
            <span class="s1">&#39;h2&#39;</span><span class="p">:</span> <span class="n">h2</span><span class="p">,</span>
            <span class="s1">&#39;h3&#39;</span><span class="p">:</span> <span class="n">h3</span><span class="p">,</span>
            <span class="s1">&#39;h4&#39;</span><span class="p">:</span> <span class="n">h4</span><span class="p">,</span>
            <span class="s1">&#39;s1&#39;</span><span class="p">:</span> <span class="n">s1</span><span class="p">,</span>
            <span class="s1">&#39;s2&#39;</span><span class="p">:</span> <span class="n">s2</span><span class="p">,</span>
            <span class="s1">&#39;s3&#39;</span><span class="p">:</span> <span class="n">s3</span><span class="p">,</span>
            <span class="s1">&#39;s4&#39;</span><span class="p">:</span> <span class="n">s4</span><span class="p">,</span>
            <span class="s1">&#39;rho&#39;</span><span class="p">:</span> <span class="n">rho</span><span class="p">,</span>  <span class="c1"># 압축기 유입 밀도 (State 1)</span>
            <span class="s1">&#39;x1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">h1</span><span class="o">-</span><span class="n">h0</span><span class="p">)</span> <span class="o">-</span> <span class="n">T0_K</span><span class="o">*</span><span class="p">(</span><span class="n">s1</span> <span class="o">-</span> <span class="n">s0</span><span class="p">),</span>
            <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">h2</span><span class="o">-</span><span class="n">h0</span><span class="p">)</span> <span class="o">-</span> <span class="n">T0_K</span><span class="o">*</span><span class="p">(</span><span class="n">s2</span> <span class="o">-</span> <span class="n">s0</span><span class="p">),</span>
            <span class="s1">&#39;x3&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">h3</span><span class="o">-</span><span class="n">h0</span><span class="p">)</span> <span class="o">-</span> <span class="n">T0_K</span><span class="o">*</span><span class="p">(</span><span class="n">s3</span> <span class="o">-</span> <span class="n">s0</span><span class="p">),</span>
            <span class="s1">&#39;x4&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">h4</span><span class="o">-</span><span class="n">h0</span><span class="p">)</span> <span class="o">-</span> <span class="n">T0_K</span><span class="o">*</span><span class="p">(</span><span class="n">s4</span> <span class="o">-</span> <span class="n">s0</span><span class="p">),</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;heating&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_lmtd_constraints</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LMTD(Log Mean Temperature Difference) 기반 제약 조건 함수들을 생성합니다.</span>
<span class="sd">    </span>
<span class="sd">    최적화 문제에서 열교환기의 실제 열전달량과 사이클 계산 열량이 일치해야 합니다:</span>
<span class="sd">    - Q_LMTD: LMTD와 UA값을 이용한 실제 열전달량 (Q = UA * LMTD)</span>
<span class="sd">    - Q_ref: 냉매 사이클 계산으로부터 얻은 열량 (Q = m_dot * (h_in - h_out))</span>
<span class="sd">    </span>
<span class="sd">    이 두 값이 같아야 물리적으로 일관된 해가 됩니다.</span>
<span class="sd">    </span>
<span class="sd">    호출 관계:</span>
<span class="sd">    - 호출자: find_ref_loop_optimal_operation (최적화 시 제약 조건으로 사용)</span>
<span class="sd">    - 사용: scipy.optimize.minimize의 제약 조건으로 전달</span>
<span class="sd">    </span>
<span class="sd">    물리적 의미:</span>
<span class="sd">    ──────────────────────────────────────────────────────────────────────────</span>
<span class="sd">    열교환기 모델링에서 두 가지 열량 계산 방법이 있습니다:</span>
<span class="sd">    </span>
<span class="sd">    1. LMTD 방법 (현실적 제약):</span>
<span class="sd">       Q_LMTD = UA * LMTD</span>
<span class="sd">       - UA: 총괄 열전달 계수 * 면적 [W/K]</span>
<span class="sd">       - LMTD: 대수 평균 온도차 [K]</span>
<span class="sd">       - 열교환기 물리적 특성 반영</span>
<span class="sd">    </span>
<span class="sd">    2. 냉매 사이클 방법 (이상적):</span>
<span class="sd">       Q_ref = m_dot * (h_in - h_out)</span>
<span class="sd">       - m_dot: 냉매 유량 [kg/s]</span>
<span class="sd">       - h_in, h_out: 입구/출구 엔탈피 [J/kg]</span>
<span class="sd">       - 에너지 보존 법칙 기반</span>
<span class="sd">    </span>
<span class="sd">    최적화 목표:</span>
<span class="sd">    Q_LMTD_cond - Q_ref_cond = 0  (응축기)</span>
<span class="sd">    Q_LMTD_evap - Q_ref_evap = 0  (증발기)</span>
<span class="sd">    </span>
<span class="sd">    이 제약 조건을 만족하는 최적 운전점에서:</span>
<span class="sd">    - 열교환기의 실제 열전달 능력과 사이클 열량이 일치</span>
<span class="sd">    - 물리적으로 현실 가능한 운전 조건</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        list: 제약 조건 함수 리스트 (각 함수는 scipy.optimize.minimize에서 사용)</span>
<span class="sd">            - constraint_tank: 응축기(저탕조) 제약 조건</span>
<span class="sd">            - constraint_hx: 증발기(열교환기) 제약 조건</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">        - 제약 조건 함수는 최적화 중 performance 딕셔너리를 받아 제약 값 반환</span>
<span class="sd">        - 반환값이 0이 되어야 제약 조건 만족</span>
<span class="sd">        - perf가 None이면 큰 패널티(1e6) 반환하여 최적화에서 제외</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">constraint_tank</span><span class="p">(</span><span class="n">perf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        응축기(저탕조) 제약 조건: Q_LMTD_cond - Q_ref_cond = 0</span>
<span class="sd">        </span>
<span class="sd">        응축기에서 냉매가 방출하는 열량(Q_ref_cond)과 응축기가 응축기  측 두 냉매 지점의 온도 값과 열전달계수에 기반해</span>
<span class="sd">        전달가능한 열량(Q_LMTD_cond)이 일치해야 합니다.</span>
<span class="sd">        이 제약 조건은 열교환기 물리적 특성과 사이클 열량의 일관성을 보장하는 제약 조건입니다.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            perf (dict): 사이클 성능 결과 딕셔너리</span>
<span class="sd">                - Q_LMTD_cond (float): LMTD 기반 응축기 열량 [W]</span>
<span class="sd">                - Q_ref_cond (float): 사이클 계산 응축기 열량 [W]</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            float: 제약 조건 값</span>
<span class="sd">                - 0: 제약 조건 만족</span>
<span class="sd">                - != 0: 제약 조건 불만족 (최적화 알고리즘이 이 값을 0에 가깝게 만들려고 시도)</span>
<span class="sd">                - 1e6: perf가 None인 경우 (물리적으로 불가능한 상태)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">perf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1e6</span>  <span class="c1"># 물리적으로 불가능한 상태에 대한 큰 패널티</span>
        <span class="k">return</span> <span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Q_LMTD_cond&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Q_ref_cond&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">constraint_hx</span><span class="p">(</span><span class="n">perf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        증발기(열교환기) 제약 조건: Q_LMTD_evap - Q_ref_evap = 0</span>
<span class="sd">        </span>
<span class="sd">        증발기에서 냉매가 흡수하는 열량(Q_ref_evap)과 증발기가 증발기 측 두 냉매 지점의 온도 값과 열전달계수에 기반해</span>
<span class="sd">        전달가능한 열량(Q_LMTD_evap)이 일치해야 합니다.</span>
<span class="sd">        일치해야 합니다. 이 제약 조건은 지중열교환기 물리적 특성과 사이클 열량의 일관성을 보장합니다.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            perf (dict): 사이클 성능 결과 딕셔너리</span>
<span class="sd">                - Q_LMTD_evap (float): LMTD 기반 증발기 열량 [W]</span>
<span class="sd">                - Q_ref_evap (float): 사이클 계산 증발기 열량 [W]</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            float: 제약 조건 값</span>
<span class="sd">                - 0: 제약 조건 만족</span>
<span class="sd">                - != 0: 제약 조건 불만족 (최적화 알고리즘이 이 값을 0에 가깝게 만들려고 시도)</span>
<span class="sd">                - 1e6: perf가 None인 경우 (물리적으로 불가능한 상태)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">perf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1e6</span>  <span class="c1"># 물리적으로 불가능한 상태에 대한 큰 패널티</span>
        <span class="k">return</span> <span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Q_LMTD_evap&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Q_ref_evap&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="n">constraint_tank</span><span class="p">,</span> <span class="n">constraint_hx</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_ref_loop_optimal_operation</span><span class="p">(</span>
    <span class="n">calculate_performance_func</span><span class="p">,</span>  <span class="c1"># 사이클 성능 계산 함수 (사용자 정의)</span>
    <span class="n">T_tank_w</span><span class="p">,</span>  <span class="c1"># 저탕조 온도 [°C]</span>
    <span class="n">T_oa</span><span class="p">,</span>  <span class="c1"># 실외 공기 온도 [°C]</span>
    <span class="n">Q_cond_load</span><span class="p">,</span>  <span class="c1"># 저탕조 목표 열 교환율 [W]</span>
    <span class="n">Q_cond_LOAD_OFF_TOL</span><span class="o">=</span><span class="mf">500.0</span><span class="p">,</span>  <span class="c1"># OFF 임계값 [W]</span>
    <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># 최적화 변수 경계 [(min, max), ...]</span>
    <span class="n">initial_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># 초기 추정값</span>
    <span class="n">constraint_funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># 제약 조건 함수 리스트</span>
    <span class="n">off_result_formatter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># OFF 상태 결과 포맷팅 함수</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    냉매 루프 최적 운전점을 찾는 함수.</span>
<span class="sd">    </span>
<span class="sd">    이 함수는 히트펌프 시스템에서 주어진 목표 열 교환율(Q_cond_load)을 만족하면서</span>
<span class="sd">    압축기 전력을 최소화하는 최적 운전점을 탐색합니다.</span>
<span class="sd">    </span>
<span class="sd">    최적화 문제:</span>
<span class="sd">    ──────────────────────────────────────────────────────────────────────────</span>
<span class="sd">    목적 함수 (minimize): E_cmp (압축기 전력 [W])</span>
<span class="sd">    </span>
<span class="sd">    최적화 변수:</span>
<span class="sd">    - optimization_vars[0]: dT_ref_HX (냉매-열교환기 온도차 [K])</span>
<span class="sd">    - optimization_vars[1]: dT_ref_tank (냉매-저탕조 온도차 [K])</span>
<span class="sd">    </span>
<span class="sd">    제약 조건:</span>
<span class="sd">    - Q_LMTD_cond - Q_ref_cond = 0  (응축기 열량 일치)</span>
<span class="sd">    - Q_LMTD_evap - Q_ref_evap = 0  (증발기 열량 일치)</span>
<span class="sd">    </span>
<span class="sd">    알고리즘:</span>
<span class="sd">    ──────────────────────────────────────────────────────────────────────────</span>
<span class="sd">    1. OFF 상태 판단: Q_cond_load가 임계값 이하이면 OFF 상태 처리</span>
<span class="sd">    2. 최적화 변수 초기화: bounds, initial_guess 설정</span>
<span class="sd">    3. 목적 함수 정의: E_cmp를 최소화</span>
<span class="sd">    4. 제약 조건 설정: LMTD 기반 제약 조건 추가</span>
<span class="sd">    5. SLSQP 알고리즘으로 최적화 실행</span>
<span class="sd">    6. 최적해 검증 및 결과 반환</span>
<span class="sd">    </span>
<span class="sd">    호출 관계:</span>
<span class="sd">    ──────────────────────────────────────────────────────────────────────────</span>
<span class="sd">    호출자: </span>
<span class="sd">    AirSourceHeatPumpBoiler.run_simulation (DHW_main_engine.py) 또는</span>
<span class="sd">    GroundSourceHeatPumpBoiler.run_simulation (DHW_main_engine.py)</span>
<span class="sd">        ↓</span>
<span class="sd">    find_ref_loop_optimal_operation (본 함수)</span>
<span class="sd">        ├─ calculate_performance_func 호출 (최적화 반복 중 여러 번)</span>
<span class="sd">        │   └─ _calculate_gshpb_next_step (DHW_main_engine.py)</span>
<span class="sd">        │       └─ compute_refrigerant_thermodynamic_states 호출</span>
<span class="sd">        ├─ constraint_funcs 호출 (제약 조건 평가)</span>
<span class="sd">        │   └─ create_lmtd_constraints() 반환 함수들</span>
<span class="sd">        └─ off_result_formatter 호출 (OFF 상태 시)</span>
<span class="sd">            └─ _format_gshpb_off_results_dict (DHW_main_engine.py)</span>
<span class="sd">    </span>
<span class="sd">    데이터 흐름:</span>
<span class="sd">    ──────────────────────────────────────────────────────────────────────────</span>
<span class="sd">    [T_tank_w, Q_cond_load, optimization_vars]</span>
<span class="sd">        ↓</span>
<span class="sd">    calculate_performance_func</span>
<span class="sd">        ↓ [성능 딕셔너리: E_cmp, Q_LMTD_cond, Q_LMTD_evap, ...]</span>
<span class="sd">    최적화 알고리즘 (반복)</span>
<span class="sd">        ↓</span>
<span class="sd">    [최적 optimization_vars]</span>
<span class="sd">        ↓</span>
<span class="sd">    calculate_performance_func (최종 1회)</span>
<span class="sd">        ↓</span>
<span class="sd">    [최적 운전점 결과]</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        calculate_performance_func (callable): </span>
<span class="sd">            사이클 성능 계산 함수 (사용자 정의).</span>
<span class="sd">            시그니처: calculate_performance_func(optimization_vars, T_tank_w, Q_cond_load) -&gt; dict</span>
<span class="sd">            </span>
<span class="sd">            입력:</span>
<span class="sd">                - optimization_vars (list): 최적화 변수 배열</span>
<span class="sd">                  예: [dT_ref_HX, dT_ref_tank] (온도차 [K])</span>
<span class="sd">                - T_tank_w (float): 저탕조 온도 [°C]</span>
<span class="sd">                - Q_cond_load (float): 저탕조 목표 열 교환율 [W]</span>
<span class="sd">            </span>
<span class="sd">            출력 (dict):</span>
<span class="sd">                - E_cmp (float): 압축기 전력 [W] (목적 함수)</span>
<span class="sd">                - Q_LMTD_cond (float): LMTD 기반 응축기 열량 [W] (제약 조건)</span>
<span class="sd">                - Q_ref_cond (float): 사이클 계산 응축기 열량 [W] (제약 조건)</span>
<span class="sd">                - Q_LMTD_evap (float): LMTD 기반 증발기 열량 [W] (제약 조건)</span>
<span class="sd">                - Q_ref_evap (float): 사이클 계산 증발기 열량 [W] (제약 조건)</span>
<span class="sd">                - 기타 성능 데이터</span>
<span class="sd">        </span>
<span class="sd">        T_tank_w (float): 저탕조 목표 온도 [°C]</span>
<span class="sd">        Q_cond_load (float): 저탕조 목표 열 교환율 [W]</span>
<span class="sd">        Q_cond_LOAD_OFF_TOL (float): OFF 임계값 [W] (기본값: 500.0)</span>
<span class="sd">            |Q_cond_load| &lt;= 이 값이면 히트펌프를 OFF 상태로 처리</span>
<span class="sd">        </span>
<span class="sd">        bounds (list, optional): 최적화 변수 경계 [(min, max), ...]</span>
<span class="sd">            기본값: [(0.1, 30.0), (0.1, 30.0)] (두 변수 모두 0.1~30.0 K)</span>
<span class="sd">        </span>
<span class="sd">        initial_guess (list, optional): 초기 추정값</span>
<span class="sd">            기본값: [5.0, 5.0] (온도차 5K로 시작)</span>
<span class="sd">        </span>
<span class="sd">        constraint_funcs (list, optional): 제약 조건 함수 리스트</span>
<span class="sd">            각 함수는 perf (dict)를 받아 제약 조건 값을 반환</span>
<span class="sd">            기본값: None (제약 조건 없음)</span>
<span class="sd">            예: create_lmtd_constraints() 반환값</span>
<span class="sd">        </span>
<span class="sd">        off_result_formatter (callable, optional): </span>
<span class="sd">            OFF 상태 결과 포맷팅 함수.</span>
<span class="sd">            시그니처: off_result_formatter(T_tank_w, Q_cond_load, T_oa=T_oa) -&gt; dict</span>
<span class="sd">            기본값: None (기본 OFF 로직 사용)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: 최적화 결과 또는 OFF 상태 결과</span>
<span class="sd">            - 최적화 성공 시: calculate_performance_func의 반환값 (최적 운전점)</span>
<span class="sd">            - OFF 상태 시: off_result_formatter의 반환값 또는 기본 OFF 결과</span>
<span class="sd">            - 최적화 실패 시: None</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">        - SLSQP (Sequential Least Squares Programming) 알고리즘 사용</span>
<span class="sd">        - 최적화는 비선형 제약 조건을 포함한 비선형 최적화 문제</span>
<span class="sd">        - calculate_performance_func는 최적화 중 여러 번 호출됨 (수렴할 때까지)</span>
<span class="sd">        - 최종적으로는 최적해에서 한 번 더 호출하여 정확한 결과 반환</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 1단계: OFF 상태 판단 및 처리</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Q_cond_load</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Q_cond_LOAD_OFF_TOL</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">off_result_formatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">off_result_formatter</span><span class="p">(</span><span class="n">T_tank_w</span><span class="p">,</span> <span class="n">Q_cond_load</span><span class="p">,</span> <span class="n">T_oa</span><span class="o">=</span><span class="n">T_oa</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dummy_vars</span> <span class="o">=</span> <span class="n">initial_guess</span> <span class="k">if</span> <span class="n">initial_guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">]</span>
                <span class="n">result_template</span> <span class="o">=</span> <span class="n">calculate_performance_func</span><span class="p">(</span>
                    <span class="n">optimization_vars</span><span class="o">=</span><span class="n">dummy_vars</span><span class="p">,</span>
                    <span class="n">T_tank_w</span><span class="o">=</span><span class="n">T_tank_w</span><span class="p">,</span>
                    <span class="n">Q_cond_load</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">T_oa</span><span class="o">=</span><span class="n">T_oa</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">result_template</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                
                <span class="c1"># 모든 숫자 값을 0.0으로 설정 (히트펌프 OFF 상태)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result_template</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                        <span class="n">result_template</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                
                <span class="n">result_template</span><span class="p">[</span><span class="s1">&#39;is_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># OFF 상태 플래그 설정</span>
                <span class="k">return</span> <span class="n">result_template</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
    

    <span class="c1"># 제약 조건 함수 리스트 초기화</span>
    <span class="k">if</span> <span class="n">constraint_funcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">constraint_funcs</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># ============================================================</span>
    <span class="c1"># 3단계: 목적 함수 정의</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># 목적: 압축기 전력(E_cmp) 최소화</span>
    <span class="c1"># 이 함수는 최적화 알고리즘에 의해 반복 호출됨</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        목적 함수: 압축기 전력 최소화</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            x (array): 최적화 변수 [dT_ref_HX, dT_ref_tank]</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            float: 압축기 전력 [W] (최소화 대상)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 주어진 최적화 변수로 사이클 성능 계산</span>
            <span class="n">perf</span> <span class="o">=</span> <span class="n">calculate_performance_func</span><span class="p">(</span>
                <span class="n">optimization_vars</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                <span class="n">T_tank_w</span><span class="o">=</span><span class="n">T_tank_w</span><span class="p">,</span>
                <span class="n">Q_cond_load</span><span class="o">=</span><span class="n">Q_cond_load</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">perf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1e6</span>  <span class="c1"># 계산 실패 시 큰 패널티</span>
            <span class="k">return</span> <span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;E_cmp&quot;</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">)</span>  <span class="c1"># 압축기 전력 반환</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1e6</span>  <span class="c1"># 예외 발생 시 큰 패널티</span>
    
    <span class="c1"># 4단계: 제약 조건 설정</span>
    <span class="n">cons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">constraint_func</span> <span class="ow">in</span> <span class="n">constraint_funcs</span><span class="p">:</span>
        <span class="c1"># 클로저를 사용하여 각 제약 조건 함수를 올바르게 바인딩</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">make_constraint</span><span class="p">(</span><span class="n">cf</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            제약 조건 함수 래퍼</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                cf (callable): 원본 제약 조건 함수 (perf를 받아 제약 값 반환)</span>
<span class="sd">            </span>
<span class="sd">            Returns:</span>
<span class="sd">                callable: 최적화 변수를 받는 제약 조건 함수</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">constraint</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                최적화 변수를 받는 제약 조건 함수</span>
<span class="sd">                </span>
<span class="sd">                Args:</span>
<span class="sd">                    x (array): 최적화 변수 [dT_ref_HX, dT_ref_tank]</span>
<span class="sd">                </span>
<span class="sd">                Returns:</span>
<span class="sd">                    float: 제약 조건 값 (0이 되어야 함)</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># 최적화 변수로 성능 계산</span>
                <span class="n">perf</span> <span class="o">=</span> <span class="n">calculate_performance_func</span><span class="p">(</span>
                    <span class="n">optimization_vars</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                    <span class="n">T_tank_w</span><span class="o">=</span><span class="n">T_tank_w</span><span class="p">,</span>
                    <span class="n">Q_cond_load</span><span class="o">=</span><span class="n">Q_cond_load</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">perf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mf">1e6</span>  <span class="c1"># 계산 실패 시 큰 패널티</span>
                <span class="c1"># 원본 제약 조건 함수 호출 (LMTD 기반 제약)</span>
                <span class="k">return</span> <span class="n">cf</span><span class="p">(</span><span class="n">perf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">constraint</span>
        <span class="n">cons</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="n">make_constraint</span><span class="p">(</span><span class="n">constraint_func</span><span class="p">)})</span>
    
    <span class="c1"># 5단계: 최적화 실행</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
            <span class="n">objective</span><span class="p">,</span>              <span class="c1"># 목적 함수 (E_cmp 최소화)</span>
            <span class="n">initial_guess</span><span class="p">,</span>          <span class="c1"># 초기 추정값</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>         <span class="c1"># Sequential Least Squares Programming</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>          <span class="c1"># 변수 경계 조건</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span> <span class="k">if</span> <span class="n">cons</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># 등식 제약 조건</span>
            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>  <span class="c1"># 상세 출력 비활성화</span>
        <span class="p">)</span>
        
        <span class="c1"># 최적화 성공 여부 확인</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="c1"># 최적해에서 최종 성능 계산 (정확한 결과 얻기 위해)</span>
            <span class="n">optimal_vars</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
            <span class="n">final_performance</span> <span class="o">=</span> <span class="n">calculate_performance_func</span><span class="p">(</span>
                <span class="n">optimization_vars</span><span class="o">=</span><span class="n">optimal_vars</span><span class="p">,</span>
                <span class="n">T_tank_w</span><span class="o">=</span><span class="n">T_tank_w</span><span class="p">,</span>
                <span class="n">Q_cond_load</span><span class="o">=</span><span class="n">Q_cond_load</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">final_performance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 최적화 실패 (수렴하지 못함)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;최적화에 실패했습니다: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># 최적화 중 예외 발생</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;최적화 중 오류 발생: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_cycle_diagrams</span><span class="p">(</span>
    <span class="n">result</span><span class="p">,</span>
    <span class="n">refrigerant</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">time_step_annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_temp_limits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">T_tank_w</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">T_b_f_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">T_b_f_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">face_color</span><span class="o">=</span><span class="s1">&#39;#F9F8F6&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    계산된 사이클 상태(1,2,3,4)를 바탕으로 P-h 및 T-h 선도를 그립니다.</span>
<span class="sd">    </span>
<span class="sd">    이 함수는 히트펌프 사이클의 열역학적 상태를 시각화합니다:</span>
<span class="sd">    - P-h 선도 (Pressure-Enthalpy): 압력 대 엔탈피 (로그 스케일)</span>
<span class="sd">    - T-h 선도 (Temperature-Enthalpy): 온도 대 엔탈피</span>
<span class="sd">    </span>
<span class="sd">    호출 관계:</span>
<span class="sd">    - 호출자: GroundSourceHeatPumpBoiler.run_simulation (save_ph_diagram=True일 때)</span>
<span class="sd">    - 사용 데이터: compute_refrigerant_thermodynamic_states 결과</span>
<span class="sd">    </span>
<span class="sd">    플로팅 단계:</span>
<span class="sd">    ──────────────────────────────────────────────────────────────────────────</span>
<span class="sd">    1. 냉매 물성 데이터 준비 (포화선, 임계점)</span>
<span class="sd">    2. 사이클 상태점 데이터 추출 (State 1-4)</span>
<span class="sd">    3. Figure 및 Axes 생성 (1행 2열: P-h, T-h)</span>
<span class="sd">    4. 포화선 그리기 (액체선, 증기선)</span>
<span class="sd">    5. 사이클 경로 그리기 (State 1→2→3→4→1)</span>
<span class="sd">    6. 온도 제한선 표시 (선택적)</span>
<span class="sd">    7. 상태점 라벨링 (1, 2, 3, 4)</span>
<span class="sd">    8. 축 설정 및 저장/표시</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        result (dict): 사이클 성능 결과 딕셔너리</span>
<span class="sd">            - P1, P2, P3, P4 (float): 압력 [Pa]</span>
<span class="sd">            - h1, h2, h3, h4 (float): 엔탈피 [J/kg]</span>
<span class="sd">            - T1, T2, T3, T4 (float): 온도 [°C]</span>
<span class="sd">                주의: result 딕셔너리에는 &#39;T1&#39;, &#39;T2&#39; 등이 °C 단위로 저장되어야 함</span>
<span class="sd">        </span>
<span class="sd">        refrigerant (str): 냉매 이름 (CoolProp 형식, 예: &#39;R410A&#39;)</span>
<span class="sd">        </span>
<span class="sd">        show (bool, optional): 그래프를 화면에 표시할지 여부 (기본값: True)</span>
<span class="sd">        </span>
<span class="sd">        time_step_annotation (str, optional): 타임스텝 주석 텍스트</span>
<span class="sd">            예: &quot;Time step: 100&quot;, &quot;Day 1, Hour 12&quot; 등</span>
<span class="sd">        </span>
<span class="sd">        save_path (str, optional): 그래프 저장 경로</span>
<span class="sd">            제공되면 이미지 파일로 저장 (PNG, DPI 400)</span>
<span class="sd">        </span>
<span class="sd">        show_temp_limits (bool, optional): 온도 제한선 표시 여부 (기본값: False)</span>
<span class="sd">            True일 때 T-h 선도에 저탕조 및 지열교환기 온도선 표시</span>
<span class="sd">        </span>
<span class="sd">        T_tank_w (float, optional): 저탕조 온도 [°C]</span>
<span class="sd">            show_temp_limits=True일 때 사용</span>
<span class="sd">        </span>
<span class="sd">        T_b_f_in (float, optional): 지열교환기 유입수 온도 [°C]</span>
<span class="sd">            show_temp_limits=True일 때 사용</span>
<span class="sd">        </span>
<span class="sd">        T_b_f_out (float, optional): 지열교환기 유출수 온도 [°C]</span>
<span class="sd">            show_temp_limits=True일 때 사용</span>
<span class="sd">        </span>
<span class="sd">        face_color (str, optional): 그래프 배경색 (기본값: &#39;#F9F8F6&#39;)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        ImportError: dartwork_mpl 모듈이 설치되지 않은 경우</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">        - P-h 선도는 압력 축이 로그 스케일</span>
<span class="sd">        - 사이클 경로는 점선으로 표시되고 각 상태점에 마커 표시</span>
<span class="sd">        - 동일 좌표의 상태점은 &quot;1,2&quot; 형태로 그룹 표시</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># 0단계: 의존성 확인</span>
    <span class="c1"># ============================================================</span>
    <span class="k">if</span> <span class="n">dm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;dartwork_mpl 모듈이 필요합니다. pip install dartwork_mpl로 설치하세요.&quot;</span><span class="p">)</span>
    
    <span class="c1"># ============================================================</span>
    <span class="c1"># 1단계: 색상 및 축 범위 설정</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># 그래프 색상 정의</span>
    <span class="n">color1</span> <span class="o">=</span> <span class="s1">&#39;dm.blue5&#39;</span>   <span class="c1"># 포화 액체선</span>
    <span class="n">color2</span> <span class="o">=</span> <span class="s1">&#39;dm.red5&#39;</span>    <span class="c1"># 포화 증기선</span>
    <span class="n">color3</span> <span class="o">=</span> <span class="s1">&#39;dm.black&#39;</span>   <span class="c1"># 사이클 경로 마커</span>

    <span class="c1"># P-h 선도 축 범위 (압력: 로그 스케일)</span>
    <span class="n">ymin1</span><span class="p">,</span> <span class="n">ymax1</span><span class="p">,</span> <span class="n">yint1</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span>  <span class="c1"># 압력 [kPa]: 500 ~ 10000</span>
    
    <span class="c1"># T-h 선도 축 범위 (온도: 선형 스케일)</span>
    <span class="n">ymin2</span><span class="p">,</span> <span class="n">ymax2</span><span class="p">,</span> <span class="n">yint2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">20</span>  <span class="c1"># 온도 [°C]: -20 ~ 120</span>
    
    <span class="c1"># 공통 X축 범위 (엔탈피)</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">100</span>  <span class="c1"># 엔탈피 [kJ/kg]: 0 ~ 600</span>

    <span class="c1"># ============================================================</span>
    <span class="c1"># 2단계: 냉매 물성 데이터 준비 (포화선 계산)</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># 임계점 계산 (참고용)</span>
    <span class="n">T_critical</span> <span class="o">=</span> <span class="n">cu</span><span class="o">.</span><span class="n">K2C</span><span class="p">(</span><span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;Tcrit&#39;</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">))</span>  <span class="c1"># 임계 온도 [°C]</span>
    <span class="n">P_critical</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;Pcrit&#39;</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>  <span class="c1"># 임계 압력 [kPa] (참고용)</span>

    <span class="c1"># 포화선 계산을 위한 온도 범위 설정</span>
    <span class="c1"># 최소 온도부터 임계 온도까지 200개 포인트</span>
    <span class="n">temps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cu</span><span class="o">.</span><span class="n">K2C</span><span class="p">(</span><span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;Tmin&#39;</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T_critical</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    
    <span class="c1"># 각 온도에서 포화 액체 및 포화 증기 엔탈피 계산</span>
    <span class="c1"># 단위 변환: J/kg → kJ/kg</span>
    <span class="n">h_liq</span> <span class="o">=</span> <span class="p">[</span><span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">cu</span><span class="o">.</span><span class="n">C2K</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span> <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="n">temps</span><span class="p">]</span>  <span class="c1"># 포화 액체선</span>
    <span class="n">h_vap</span> <span class="o">=</span> <span class="p">[</span><span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">cu</span><span class="o">.</span><span class="n">C2K</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span> <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="n">temps</span><span class="p">]</span>  <span class="c1"># 포화 증기선</span>
    
    <span class="c1"># 각 온도에서 포화 압력 계산</span>
    <span class="c1"># 단위 변환: Pa → kPa</span>
    <span class="n">p_sat</span> <span class="o">=</span> <span class="p">[</span><span class="n">CP</span><span class="o">.</span><span class="n">PropsSI</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">cu</span><span class="o">.</span><span class="n">C2K</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">refrigerant</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span> <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="n">temps</span><span class="p">]</span>

    <span class="c1"># ============================================================</span>
    <span class="c1"># 3단계: 사이클 상태점 데이터 추출</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># State 1-4의 압력, 엔탈피, 온도 추출</span>
    <span class="c1"># 단위 변환: Pa → kPa, J/kg → kJ/kg</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;P</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)])</span> <span class="o">*</span> <span class="n">cu</span><span class="o">.</span><span class="n">Pa2kPa</span>  <span class="c1"># 압력 [kPa]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;h</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)])</span> <span class="o">*</span> <span class="n">cu</span><span class="o">.</span><span class="n">J2kJ</span>   <span class="c1"># 엔탈피 [kJ/kg]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;T</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)])</span>             <span class="c1"># 온도 [°C]</span>

    <span class="c1"># ============================================================</span>
    <span class="c1"># 4단계: 사이클 경로 구성 (닫힌 경로)</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># State 1→2→3→4→1 순서로 닫힌 경로 만들기</span>
    <span class="c1"># 첫 상태점을 끝에 추가하여 경로를 닫음</span>
    <span class="n">h_cycle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">[:</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># [h1, h2, h3, h4, h1]</span>
    <span class="n">p_cycle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">[:</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># [p1, p2, p3, p4, p1]</span>
    <span class="n">T_cycle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">[:</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># [T1, T2, T3, T4, T1]</span>

    <span class="c1"># ============================================================</span>
    <span class="c1"># 5단계: Figure 및 Axes 생성</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># 선 두께 배열 (그래프 요소별로 다른 두께 사용)</span>
    <span class="n">LW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
    
    <span class="c1"># 1행 2열 서브플롯 생성 (P-h 선도, T-h 선도)</span>
    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">cm2in</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">dm</span><span class="o">.</span><span class="n">cm2in</span><span class="p">(</span><span class="mi">6</span><span class="p">)),</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># 서브플롯 간 간격</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># 1차원 배열로 변환</span>

    <span class="c1"># ============================================================</span>
    <span class="c1"># 6단계: 축별 메타데이터 설정</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># 각 서브플롯(idx=0: P-h, idx=1: T-h)의 축 라벨 및 스케일</span>
    <span class="n">xlabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Enthalpy [kJ/kg]&quot;</span><span class="p">,</span> <span class="s2">&quot;Enthalpy [kJ/kg]&quot;</span><span class="p">]</span>  <span class="c1"># 공통 X축: 엔탈피</span>
    <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Pressure (log scale) [kPa]&quot;</span><span class="p">,</span> <span class="s2">&quot;Temperature [°C]&quot;</span><span class="p">]</span>  <span class="c1"># Y축: 압력 또는 온도</span>
    <span class="n">yscales</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">]</span>  <span class="c1"># Y축 스케일: 로그 또는 선형</span>
    <span class="n">xlims</span>   <span class="o">=</span> <span class="p">[(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)]</span>  <span class="c1"># X축 범위</span>
    <span class="n">ylims</span>   <span class="o">=</span> <span class="p">[(</span><span class="n">ymin1</span><span class="p">,</span> <span class="n">ymax1</span><span class="p">),</span> <span class="p">(</span><span class="n">ymin2</span><span class="p">,</span> <span class="n">ymax2</span><span class="p">)]</span>  <span class="c1"># Y축 범위</span>

    <span class="c1"># 포화선/사이클 Y데이터 선택자</span>
    <span class="c1"># idx=0 (P-h 선도): 포화선은 p_sat, 사이클은 p_cycle</span>
    <span class="c1"># idx=1 (T-h 선도): 포화선은 temps, 사이클은 T_cycle</span>
    <span class="n">satY_list</span>   <span class="o">=</span> <span class="p">[</span><span class="n">p_sat</span><span class="p">,</span> <span class="n">temps</span><span class="p">]</span>  <span class="c1"># 포화선 Y 데이터</span>
    <span class="n">cycleY_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_cycle</span><span class="p">,</span> <span class="n">T_cycle</span><span class="p">]</span>  <span class="c1"># 사이클 경로 Y 데이터</span>

    <span class="c1"># 상태점 라벨 Y좌표 계산 함수 (축별로 다른 오프셋 적용)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">state_y</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;상태점 라벨 Y좌표 계산&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># P-h 선도: 압력 위로 5% 오프셋</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># T-h 선도: 온도 위로 고정 오프셋</span>
            <span class="k">return</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">yint2</span> <span class="o">*</span> <span class="mf">0.1</span>

    <span class="c1"># ============================================================</span>
    <span class="c1"># 7단계: 범례 스타일 설정</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># 공통 범례 스타일 (두 서브플롯 모두 동일)</span>
    <span class="n">legend_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span>          <span class="c1"># 범례 위치</span>
        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">),</span>  <span class="c1"># 범례 앵커 포인트</span>
        <span class="n">handlelength</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>          <span class="c1"># 범례 항목 길이</span>
        <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>          <span class="c1"># 범례 항목 간 간격</span>
        <span class="n">columnspacing</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>           <span class="c1"># 범례 열 간 간격</span>
        <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>                    <span class="c1"># 범례 열 수</span>
        <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>             <span class="c1"># 범례 프레임 없음</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">fs</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">)</span>       <span class="c1"># 범례 폰트 크기</span>
    <span class="p">)</span>

    <span class="c1"># ============================================================</span>
    <span class="c1"># 8단계: 각 서브플롯에 그래프 그리기</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># 2중 for문으로 P-h 선도(idx=0)와 T-h 선도(idx=1) 생성</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">c</span>  <span class="c1"># 서브플롯 인덱스 (0 또는 1)</span>
            <span class="n">axi</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="c1"># --------------------------------------------</span>
            <span class="c1"># 8-1: 포화선 그리기</span>
            <span class="c1"># --------------------------------------------</span>
            <span class="c1"># 포화 액체선: 저압 영역에서 왼쪽 경계</span>
            <span class="n">axi</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">h_liq</span><span class="p">,</span> <span class="n">satY_list</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>  <span class="n">color</span><span class="o">=</span><span class="n">color1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Saturated liquid&#39;</span><span class="p">,</span> 
                    <span class="n">linewidth</span><span class="o">=</span><span class="n">LW</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            
            <span class="c1"># 포화 증기선: 저압 영역에서 오른쪽 경계</span>
            <span class="n">axi</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">h_vap</span><span class="p">,</span> <span class="n">satY_list</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>  <span class="n">color</span><span class="o">=</span><span class="n">color2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Saturated vapor&#39;</span><span class="p">,</span>  
                    <span class="n">linewidth</span><span class="o">=</span><span class="n">LW</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            
            <span class="c1"># --------------------------------------------</span>
            <span class="c1"># 8-2: 사이클 경로 그리기</span>
            <span class="c1"># --------------------------------------------</span>
            <span class="c1"># State 1→2→3→4→1 순서의 닫힌 경로</span>
            <span class="c1"># 점선(:)과 원형 마커(o)로 표시</span>
            <span class="n">axi</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">h_cycle</span><span class="p">,</span> <span class="n">cycleY_list</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dm.gray5&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Heat pump cycle&#39;</span><span class="p">,</span>
                     <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">color3</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">color3</span><span class="p">,</span>
                     <span class="n">linewidth</span><span class="o">=</span><span class="n">LW</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># --------------------------------------------</span>
            <span class="c1"># 8-3: 온도 제한선 표시 (T-h 선도만, 선택적)</span>
            <span class="c1"># --------------------------------------------</span>
            <span class="c1"># T-h 선도(idx=1)에만 온도 제한선 표시</span>
            <span class="k">if</span> <span class="n">show_temp_limits</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># 저탕조 온수 온도선 (빨간색)</span>
                <span class="k">if</span> <span class="n">T_tank_w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">T_tank_w</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dm.red4&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">LW</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xmin</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">T_tank_w</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;Tank water: </span><span class="si">{</span><span class="n">T_tank_w</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> °C&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> 
                               <span class="n">fontsize</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">fs</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dm.red6&#39;</span><span class="p">)</span>
                
                <span class="c1"># 지열교환기 유입수 온도선 (파란색)</span>
                <span class="k">if</span> <span class="n">T_b_f_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">T_b_f_in</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dm.blue4&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">LW</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xmin</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">T_b_f_in</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;GHE inlet: </span><span class="si">{</span><span class="n">T_b_f_in</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> °C&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> 
                               <span class="n">fontsize</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">fs</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dm.blue6&#39;</span><span class="p">)</span>
                
                <span class="c1"># 지열교환기 유출수 온도선 (주황색)</span>
                <span class="k">if</span> <span class="n">T_b_f_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">T_b_f_out</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dm.orange4&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">LW</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xmin</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">T_b_f_out</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;GHE outlet: </span><span class="si">{</span><span class="n">T_b_f_out</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> °C&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> 
                               <span class="n">fontsize</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">fs</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dm.orange6&#39;</span><span class="p">)</span>

            <span class="c1"># --------------------------------------------</span>
            <span class="c1"># 8-4: 상태점 라벨 표시</span>
            <span class="c1"># --------------------------------------------</span>
            <span class="c1"># 동일 좌표의 상태점을 그룹핑하여 &quot;1,2&quot; 형태로 표시</span>
            <span class="c1"># x축: 엔탈피(h), y축: 압력(p) 또는 온도(T)</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">h</span>  <span class="c1"># 모든 서브플롯에서 X축은 엔탈피</span>
            <span class="n">ydata</span> <span class="o">=</span> <span class="n">p</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">T</span>  <span class="c1"># Y축은 서브플롯에 따라 다름</span>

            <span class="c1"># 상태점 좌표 그룹핑 (소수점 3자리 반올림으로 동일 좌표 판단)</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">yi</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">groups</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># 각 그룹에 대해 라벨 표시</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">xg</span><span class="p">,</span> <span class="n">yg</span><span class="p">),</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">label_text</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>  <span class="c1"># &quot;1,2&quot; 형태</span>
                <span class="c1"># 상태점 위로 3포인트 오프셋하여 라벨 표시</span>
                <span class="n">axi</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">label_text</span><span class="p">,</span> <span class="p">(</span><span class="n">xg</span><span class="p">,</span> <span class="n">yg</span><span class="p">),</span>
                             <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                             <span class="n">fontsize</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">fs</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">))</span>

            <span class="c1"># --------------------------------------------</span>
            <span class="c1"># 8-5: 축 설정 및 범례 추가</span>
            <span class="c1"># --------------------------------------------</span>
            <span class="c1"># 축 라벨 설정</span>
            <span class="n">axi</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabels</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">fs</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">axi</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabels</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">fs</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
            
            <span class="c1"># 눈금 표시 설정</span>
            <span class="n">axi</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">fs</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            
            <span class="c1"># Y축 스케일 설정 (로그 또는 선형)</span>
            <span class="n">axi</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="n">yscales</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            
            <span class="c1"># 축 범위 설정</span>
            <span class="n">axi</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlims</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">axi</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">ylims</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            
            <span class="c1"># 범례 추가</span>
            <span class="n">axi</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">**</span><span class="n">legend_kw</span><span class="p">)</span>
    
    <span class="c1"># ============================================================</span>
    <span class="c1"># 9단계: 타임스텝 주석 및 레이아웃 조정</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># 타임스텝 주석이 제공된 경우 우측 상단에 표시</span>
    <span class="k">if</span> <span class="n">time_step_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.97</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">,</span> 
                 <span class="n">time_step_annotation</span><span class="p">,</span>
                 <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                 <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">fs</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1"># 주석 공간 확보를 위해 레이아웃 조정</span>
        <span class="n">dm</span><span class="o">.</span><span class="n">simple_layout</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span> <span class="n">bbox</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 주석 없는 경우 전체 영역 사용</span>
        <span class="n">dm</span><span class="o">.</span><span class="n">simple_layout</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span> <span class="n">bbox</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># ============================================================</span>
    <span class="c1"># 10단계: 그래프 저장 및 표시</span>
    <span class="c1"># ============================================================</span>
    <span class="c1"># 이미지 파일로 저장 (선택적)</span>
    <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># 서브플롯 배경을 투명하게 설정</span>
        <span class="k">for</span> <span class="n">axi</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
            <span class="n">axi</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="c1"># 고해상도 이미지로 저장 (DPI 400)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">face_color</span><span class="p">)</span>
    
    <span class="c1"># 화면에 표시 (선택적)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">dm</span><span class="o">.</span><span class="n">save_and_show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    
    <span class="c1"># 메모리 해제</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">update_tank_temperature</span><span class="p">(</span>
    <span class="n">T_tank_w_K</span><span class="p">,</span>      <span class="c1"># 현재 탱크 온도 [K]</span>
    <span class="n">Q_tank_in</span><span class="p">,</span>       <span class="c1"># 탱크 입력 열량 [W]</span>
    <span class="n">total_loss</span><span class="p">,</span>      <span class="c1"># 총 손실 [W] (Q_tank_loss + Q_use_loss)</span>
    <span class="n">C_tank</span><span class="p">,</span>          <span class="c1"># 탱크 열용량 [J/K]</span>
    <span class="n">dt</span><span class="p">,</span>              <span class="c1"># 타임스텝 [s]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    탱크 온도를 업데이트합니다.</span>
<span class="sd">    </span>
<span class="sd">    열량 밸런스 기반으로 다음 타임스텝의 탱크 온도를 계산합니다:</span>
<span class="sd">    Q_net = Q_tank_in - total_loss</span>
<span class="sd">    T_tank_w_K_new = T_tank_w_K + (Q_net / C_tank) * dt</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    T_tank_w_K : float</span>
<span class="sd">        현재 탱크 온도 [K]</span>
<span class="sd">    Q_tank_in : float</span>
<span class="sd">        탱크 입력 열량 [W] (예: 응축기에서 전달되는 열량)</span>
<span class="sd">    total_loss : float</span>
<span class="sd">        총 손실 [W] (탱크 외벽 손실 + 급탕 사용 손실)</span>
<span class="sd">    C_tank : float</span>
<span class="sd">        탱크 열용량 [J/K] (C_tank = c_w * rho_w * V_tank)</span>
<span class="sd">    dt : float</span>
<span class="sd">        타임스텝 [s]</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        업데이트된 탱크 온도 [K]</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - 열량 밸런스: Q_net = Q_tank_in - total_loss</span>
<span class="sd">    - 온도 변화: dT = Q_net * dt / C_tank</span>
<span class="sd">    - 다음 타임스텝 온도: T_new = T_old + dT</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Q_net</span> <span class="o">=</span> <span class="n">Q_tank_in</span> <span class="o">-</span> <span class="n">total_loss</span>
    <span class="n">dT</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q_net</span> <span class="o">/</span> <span class="n">C_tank</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">T_tank_w_K_new</span> <span class="o">=</span> <span class="n">T_tank_w_K</span> <span class="o">+</span> <span class="n">dT</span>
    <span class="k">return</span> <span class="n">T_tank_w_K_new</span>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, betlab
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/bet-lab/enex_analysis_engine" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    </body>
</html>